{% extends 'base.html' %}
{% load static %}

{% block title %}Mobile Data Imports - AVICAST System{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header with Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'locations:dashboard' %}">Site Management</a></li>
            <li class="breadcrumb-item active" aria-current="page">Mobile Data Imports</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 fw-bold text-primary mb-2">
                        <i class="fas fa-mobile-alt me-3"></i>Mobile Data Imports
                    </h1>
                    <p class="lead text-muted mb-0">Manage and review mobile application data import requests</p>
                </div>
                <div class="btn-group">
                    <a href="{% url 'locations:submit_mobile_import' %}" class="btn btn-success btn-lg shadow-sm">
                        <i class="fas fa-plus me-2"></i>Submit New Import
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Filter by Status</h6>
                    <form method="get">
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="">All Statuses</option>
                            {% for status_choice in status_choices %}
                                <option value="{{ status_choice.0 }}" {% if status_filter == status_choice.0 %}selected{% endif %}>
                                    {{ status_choice.1 }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Import Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col">
                            <div class="text-center p-3">
                                <div class="p-3 bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                    <i class="fas fa-file-import text-primary fa-2x"></i>
                                </div>
                                <h4 class="text-primary mb-1 fw-bold">{{ stats.total }}</h4>
                                <small class="text-muted">Total Imports</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-3">
                                <div class="p-3 bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                    <i class="fas fa-clock text-warning fa-2x"></i>
                                </div>
                                <h4 class="text-warning mb-1 fw-bold">{{ stats.pending }}</h4>
                                <small class="text-muted">Pending Review</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-3">
                                <div class="p-3 bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                    <i class="fas fa-check text-success fa-2x"></i>
                                </div>
                                <h4 class="text-success mb-1 fw-bold">{{ stats.approved }}</h4>
                                <small class="text-muted">Approved</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-3">
                                <div class="p-3 bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                    <i class="fas fa-database text-info fa-2x"></i>
                                </div>
                                <h4 class="text-info mb-1 fw-bold">{{ stats.processed }}</h4>
                                <small class="text-muted">Processed</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-3">
                                <div class="p-3 bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                    <i class="fas fa-times text-danger fa-2x"></i>
                                </div>
                                <h4 class="text-danger mb-1 fw-bold">{{ stats.rejected }}</h4>
                                <small class="text-muted">Rejected</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions (Admin Only) -->
    {% if is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Bulk Actions</h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <form method="post" action="{% url 'locations:bulk_import_actions' %}" id="bulk-form">
                                {% csrf_token %}
                                <div class="btn-group">
                                    <button type="submit" name="bulk_action" value="approve" class="btn btn-success btn-sm" onclick="return confirmBulkAction('approve')">
                                        <i class="fas fa-check me-1"></i>Approve Selected
                                    </button>
                                    <button type="submit" name="bulk_action" value="reject" class="btn btn-danger btn-sm" onclick="return confirmBulkAction('reject')">
                                        <i class="fas fa-times me-1"></i>Reject Selected
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Import List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    {% if is_admin %}
                                    <th width="50">
                                        <input type="checkbox" id="select-all">
                                    </th>
                                    {% endif %}
                                    <th>Site</th>
                                    <th>Submitted By</th>
                                    <th>Data Preview</th>
                                    <th>Status</th>
                                    <th>Submitted</th>
                                    <th>Reviewed By</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mobile_import in page_obj %}
                                <tr>
                                    {% if is_admin %}
                                    <td>
                                        <input type="checkbox" name="import_ids" value="{{ mobile_import.id }}" form="bulk-form">
                                    </td>
                                    {% endif %}
                                    <td>
                                        <strong class="text-primary">{{ mobile_import.site.name }}</strong><br>
                                        <small class="text-muted"><i class="fas fa-map-marker-alt"></i> {{ mobile_import.site.get_site_type_display }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ mobile_import.submitted_by.get_full_name }}</strong><br>
                                        <small class="text-muted">ID: {{ mobile_import.submitted_by.employee_id }}</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% with species_count=mobile_import.import_data.species|length %}
                                            {% with total_birds=mobile_import.import_data.species|length %}
                                            <i class="fas fa-dove"></i> {{ species_count }} species<br>
                                            <i class="fas fa-calendar"></i> {{ mobile_import.import_data.observation_date|default:"Not set" }}
                                            {% endwith %}
                                            {% endwith %}
                                        </small>
                                    </td>
                                    <td>
                                        {% if mobile_import.status == 'pending' %}
                                            <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pending</span>
                                        {% elif mobile_import.status == 'approved' %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Approved</span>
                                        {% elif mobile_import.status == 'rejected' %}
                                            <span class="badge bg-danger"><i class="fas fa-times"></i> Rejected</span>
                                        {% elif mobile_import.status == 'processed' %}
                                            <span class="badge bg-info"><i class="fas fa-check-double"></i> Processed</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ mobile_import.created_at|date:"M d, Y" }}<br>
                                        <span class="text-muted">{{ mobile_import.created_at|date:"H:i" }}</span></small>
                                    </td>
                                    <td>
                                        {% if mobile_import.reviewed_by %}
                                            <strong>{{ mobile_import.reviewed_by.get_full_name }}</strong><br>
                                            <small class="text-muted">{{ mobile_import.reviewed_at|date:"M d, H:i" }}</small>
                                        {% else %}
                                            <em class="text-muted">—</em>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'locations:review_mobile_import' mobile_import.id %}" 
                                               class="btn btn-outline-primary" 
                                               title="Review Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if is_admin and mobile_import.status == 'approved' %}
                                            <button class="btn btn-outline-success" 
                                                    onclick="processImport('{{ mobile_import.id }}')"
                                                    title="Process Import">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{% if is_admin %}8{% else %}7{% endif %}" class="text-center py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                                        <h5 class="text-muted">No mobile data imports found</h5>
                                        <p class="text-muted mb-0">Import requests will appear here when submitted from the mobile app.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Import list pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}page=1">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page_obj.next_page_number }}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Select all checkbox functionality
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            document.querySelectorAll('input[name="import_ids"]').forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        document.querySelectorAll('input[name="import_ids"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (!this.checked) {
                    selectAll.checked = false;
                } else {
                    // Check if all are now checked
                    const allCheckboxes = document.querySelectorAll('input[name="import_ids"]');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    if (allChecked) {
                        selectAll.checked = true;
                    }
                }
            });
        });
    }
});

function confirmBulkAction(action) {
    const selected = document.querySelectorAll('input[name="import_ids"]:checked').length;
    if (selected === 0) {
        alert('Please select at least one import to ' + action);
        return false;
    }
    return confirm(`Are you sure you want to ${action} ${selected} import(s)?`);
}

function processImport(importId) {
    if (confirm('Are you sure you want to process this import? This will create a census observation from the imported data.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/locations/mobile-imports/${importId}/review/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'process';
        form.appendChild(actionInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
