{% extends 'base.html' %}
{% load static %}

{% block title %}{{ site.name }} - Site Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header with Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'locations:dashboard' %}">Site Management</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ site.name }}</li>
        </ol>
    </nav>

    <!-- Site Header Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-map-marker-alt me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <h2 class="mb-0 text-white">{{ site.name }}</h2>
                            <small class="text-white-50">{{ site.get_site_type_display }} Site</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- Primary Census Actions -->
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="showCensusModal()">
                                <i class="fas fa-plus me-2"></i>Add Census
                            </button>
                            <button class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'locations:census_dashboard' %}">
                                    <i class="fas fa-binoculars me-2"></i>View All Census
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'locations:bulk_census_import_list' %}">
                                    <i class="fas fa-file-import me-2"></i>Import Data
                                </a></li>
                            </ul>
                        </div>

                        <!-- Site Management Actions -->
                        <div class="btn-group">
                            <a href="{% url 'locations:sites_map' %}" class="btn btn-light btn-sm">
                                <i class="fas fa-map-marked-alt me-1"></i> Map
                            </a>
                            {% if is_admin %}
                            <a href="{% url 'locations:site_update' site.id %}" class="btn btn-light btn-sm">
                                <i class="fas fa-edit me-1"></i> Edit
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <!-- Site Information -->
                        <div class="col-lg-6 mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Site Information
                            </h5>
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <div class="d-flex align-items-center p-3 bg-light rounded">
                                        <i class="fas fa-tag text-info me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Type</small>
                                            <span class="badge bg-info fs-6">{{ site.get_site_type_display }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="d-flex align-items-center p-3 bg-light rounded">
                                        <i class="fas fa-circle text-{% if site.status == 'active' %}success{% elif site.status == 'monitoring' %}warning{% else %}secondary{% endif %} me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Status</small>
                                            <span class="badge bg-{% if site.status == 'active' %}success{% elif site.status == 'monitoring' %}warning{% else %}secondary{% endif %} fs-6">
                                                {{ site.get_status_display }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="d-flex align-items-center p-3 bg-light rounded">
                                        <i class="fas fa-location-dot text-danger me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Coordinates</small>
                                            <span class="{% if site.coordinates %}text-success{% else %}text-danger{% endif %}">
                                                {{ site.get_coordinates_display }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="d-flex align-items-center p-3 bg-light rounded">
                                        <i class="fas fa-calendar-plus text-primary me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Created</small>
                                            <span class="fw-bold">{{ site.created_at|date:"M d, Y" }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% if site.area_hectares %}
                                <div class="col-sm-6">
                                    <div class="d-flex align-items-center p-3 bg-light rounded">
                                        <i class="fas fa-ruler-combined text-warning me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Area</small>
                                            <span class="fw-bold">{{ site.area_hectares }} ha</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            {% if site.description %}
                            <div class="mt-4">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-align-left me-2"></i>Description
                                </h6>
                                <p class="mb-0 p-3 bg-light rounded">{{ site.description }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Site Statistics -->
                        <div class="col-lg-6">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-chart-bar me-2"></i>Site Overview
                            </h5>
                            <div class="row g-3">
                                <div class="col-4">
                                    <div class="card text-center border-0 bg-gradient-primary text-white h-100">
                                        <div class="card-body p-3">
                                            <i class="fas fa-paw fa-2x mb-2 opacity-75"></i>
                                            <h3 class="mb-1 fw-bold">{{ total_verified_species }}</h3>
                                            <small class="opacity-75">Species</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="card text-center border-0 bg-gradient-success text-white h-100">
                                        <div class="card-body p-3">
                                            <i class="fas fa-feather fa-2x mb-2 opacity-75"></i>
                                            <h3 class="mb-1 fw-bold">{{ total_verified_birds }}</h3>
                                            <small class="opacity-75">Total Birds</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="card text-center border-0 bg-gradient-info text-white h-100">
                                        <div class="card-body p-3">
                                            <i class="fas fa-clipboard-list fa-2x mb-2 opacity-75"></i>
                                            <h3 class="mb-1 fw-bold">{{ recent_census|length }}</h3>
                                            <small class="opacity-75">Observations</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Census Overview Section (Before Tabs) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-binoculars me-2"></i>Census Overview
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Census Summary Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card text-center border-0 bg-light">
                                <div class="card-body p-3">
                                    <i class="fas fa-clipboard-list text-primary fa-2x mb-2"></i>
                                    <h4 class="mb-1">{{ recent_census|length }}</h4>
                                    <small class="text-muted">Total Observations</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 bg-light">
                                <div class="card-body p-3">
                                    <i class="fas fa-paw text-success fa-2x mb-2"></i>
                                    <h4 class="mb-1">{{ total_verified_species }}</h4>
                                    <small class="text-muted">Species Recorded</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 bg-light">
                                <div class="card-body p-3">
                                    <i class="fas fa-feather text-info fa-2x mb-2"></i>
                                    <h4 class="mb-1">{{ total_verified_birds }}</h4>
                                    <small class="text-muted">Total Birds</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0 bg-light">
                                <div class="card-body p-3">
                                    <i class="fas fa-calendar-check text-warning fa-2x mb-2"></i>
                                    <h4 class="mb-1">
                                        {% if most_recent_census %}
                                            {{ most_recent_census.observation_date|date:'M d' }}
                                        {% else %}
                                            None
                                        {% endif %}
                                    </h4>
                                    <small class="text-muted">Last Observation</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Census Actions -->
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-success" onclick="showCensusModal()">
                            <i class="fas fa-plus me-2"></i>Add New Census
                        </button>
                        <a href="#census-records" class="btn btn-outline-primary">
                            <i class="fas fa-list me-2"></i>View All Records
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Management Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <!-- Tab Navigation -->
                <div class="card-header bg-white border-bottom-0">
                    <ul class="nav nav-tabs card-header-tabs" id="siteTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                                    data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                                <i class="fas fa-info-circle me-2"></i>Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="census-tab" data-bs-toggle="tab"
                                    data-bs-target="#census" type="button" role="tab" aria-controls="census" aria-selected="false">
                                <i class="fas fa-binoculars me-2"></i>Census Data
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab"
                                    data-bs-target="#analytics" type="button" role="tab" aria-controls="analytics" aria-selected="false">
                                <i class="fas fa-chart-line me-2"></i>Analytics
                            </button>
                        </li>
                        {% if is_admin %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
                                    data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">
                                <i class="fas fa-cog me-2"></i>Settings
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="card-body p-0">
                    <div class="tab-content" id="siteTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                            <div class="p-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-tachometer-alt me-2"></i>Site Overview
                                </h5>

                                <!-- Quick Actions -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body p-4">
                                                <h6 class="text-muted mb-3">
                                                    <i class="fas fa-rocket me-2"></i>Quick Actions
                                                </h6>
                                                <div class="row g-3">
                                                    <div class="col-md-3 col-sm-6">
                                                        <button class="btn btn-success btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4"
                                                                onclick="document.getElementById('census-tab').click()">
                                                            <i class="fas fa-plus-circle fa-3x mb-3"></i>
                                                            <span class="fw-bold">Add Census</span>
                                                            <small class="opacity-75">Record observations</small>
                                                        </button>
                                                    </div>
                                                    <div class="col-md-3 col-sm-6">
                                                        <a href="{% url 'locations:sites_map' %}" class="btn btn-info btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                                            <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                                                            <span class="fw-bold">View on Map</span>
                                                            <small class="opacity-75">Geographic view</small>
                                                        </a>
                                                    </div>
                                                    <div class="col-md-3 col-sm-6">
                                                        <a href="{% url 'locations:dashboard' %}" class="btn btn-warning btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                                            <i class="fas fa-list fa-3x mb-3"></i>
                                                            <span class="fw-bold">Browse Sites</span>
                                                            <small class="opacity-75">All sites list</small>
                                                        </a>
                                                    </div>
                                                    {% if is_admin %}
                                                    <div class="col-md-3 col-sm-6">
                                                        <a href="{% url 'locations:bulk_census_import_list' %}" class="btn btn-secondary btn-lg w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                                            <i class="fas fa-file-import fa-3x mb-3"></i>
                                                            <span class="fw-bold">Import Data</span>
                                                            <small class="opacity-75">Bulk upload</small>
                                                        </a>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Activity -->
                                {% if recent_census %}
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-secondary text-white">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-history me-2"></i>Recent Census Activity
                                                </h5>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Date</th>
                                                                <th>Species Count</th>
                                                                <th>Total Birds</th>
                                                                <th>Observer</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for census in recent_census %}
                                                            <tr class="{% if census.updated_at|timesince < '24 hours' %}table-info{% endif %}">
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <i class="fas fa-calendar-day text-primary me-2"></i>
                                                                        <strong>{{ census.observation_date|date:"M d, Y" }}</strong>
                                                                        {% if census.updated_at|timesince < '24 hours' %}
                                                                            <span class="badge bg-info ms-2" title="Recently updated">
                                                                                <i class="fas fa-clock me-1"></i>Updated {{ census.updated_at|timesince }}
                                                                            </span>
                                                                        {% endif %}
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-info fs-6">{{ census.get_total_species_count }}</span>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-success fs-6">{{ census.get_total_birds_count }}</span>
                                                                </td>
                                                                <td>
                                                                    {% if census.observer %}
                                                                        {{ census.observer.get_full_name|default:census.observer.username }}
                                                                    {% else %}
                                                                        <span class="text-muted">System Import</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <div class="btn-group btn-group-sm">
                                                                        <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('census-tab').click()">
                                                                            <i class="fas fa-eye"></i> View
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Census Data Tab -->
                        <div class="tab-pane fade" id="census" role="tabpanel" aria-labelledby="census-tab">
                            <div class="p-4">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="text-primary mb-0">
                                        <i class="fas fa-feather me-2"></i>Individual Bird Records
                                    </h5>
                                    {% if is_admin %}
                                    <div class="btn-group">
                                        <button class="btn btn-success" onclick="showCensusModal()">
                                            <i class="fas fa-plus me-2"></i>Add New Census
                                        </button>
                                        <a href="{% url 'locations:bulk_census_import_list' %}" class="btn btn-info">
                                            <i class="fas fa-file-import me-2"></i>Import Data
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Individual Bird Records Section -->
                                <div class="row mb-4" id="census-records">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-feather me-2"></i>Individual Bird Records
                                                </h5>
                                                <small class="opacity-75">Click any observation to view individual birds</small>
                                            </div>
                                            <div class="card-body p-0">
                                                {% if recent_census %}
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Date</th>
                                                                <th class="text-center">Species</th>
                                                                <th class="text-center">Total Birds</th>
                                                                <th class="text-center">Observer</th>
                                                                <th class="text-center">Individual Records</th>
                                                                <th class="text-center">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for census in recent_census %}
                                                            <tr class="census-row" data-census-id="{{ census.id }}" style="cursor: pointer;">
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <i class="fas fa-calendar-day text-primary me-2"></i>
                                                                        <strong>{{ census.observation_date|date:"M d, Y" }}</strong>
                                                                    </div>
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge bg-info fs-6">{{ census.get_total_species_count }}</span>
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge bg-success fs-6">{{ census.get_total_birds_count }}</span>
                                                                </td>
                                                                <td class="text-center">
                                                                    {% if census.observer %}
                                                                        {{ census.observer.get_full_name|default:census.observer.username }}
                                                                    {% else %}
                                                                        <span class="text-muted">System Import</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge bg-warning text-dark">
                                                                        <i class="fas fa-eye me-1"></i>{{ census.species_observations.count }} records
                                                                    </span>
                                                                </td>
                                                                <td class="text-center">
                                                                    <div class="btn-group btn-group-sm">
                                                                        <button class="btn btn-outline-info btn-sm" onclick="viewIndividualBirds({{ census.id }})" title="View individual birds">
                                                                            <i class="fas fa-feather"></i>
                                                                        </button>
                                                                        <a href="{% url 'locations:census_update' census.id %}" class="btn btn-outline-primary btn-sm" title="Edit census">
                                                                            <i class="fas fa-edit"></i>
                                                                        </a>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                {% else %}
                                                <div class="text-center py-5">
                                                    <i class="fas fa-binoculars text-muted fa-3x mb-3"></i>
                                                    <h5 class="text-muted">No Census Data Yet</h5>
                                                    <p class="text-muted mb-4">Start monitoring this site by adding your first census observation.</p>
                                                    <button class="btn btn-success" onclick="showCensusModal()">
                                                        <i class="fas fa-plus me-2"></i>Add First Census
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Species Count Tracking -->
                                {% if site_species_counts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-database me-2"></i>Species Tracking - Verified Counts
                                                </h5>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Species</th>
                                                                <th class="text-center">Total Count</th>
                                                                <th class="text-center">Observations</th>
                                                                <th class="text-center">Last Seen</th>
                                                                <th class="text-center">Status</th>
                                                                {% if is_admin %}
                                                                <th class="text-center">Actions</th>
                                                                {% endif %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for species_count in site_species_counts %}
                                                            <tr>
                                                                <td>
                                                                    <strong class="text-primary">{{ species_count.species.name }}</strong>
                                                                    <br><small class="text-muted">{{ species_count.species.scientific_name }}</small>
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge bg-success fs-6">{{ species_count.total_count }}</span>
                                                                </td>
                                                                <td class="text-center">{{ species_count.observation_count }}</td>
                                                                <td class="text-center">
                                                                    {% if species_count.last_observation_date %}
                                                                    {{ species_count.last_observation_date|date:"M d, Y" }}
                                                                    {% else %}
                                                                    <span class="text-muted">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge bg-success">
                                                                        <i class="fas fa-check-circle me-1"></i>Verified
                                                                    </span>
                                                                </td>
                                                                {% if is_admin %}
                                                                <td class="text-center">
                                                                    <button class="btn btn-sm btn-info" onclick="viewMonthlyBreakdown('{{ species_count.id }}')">
                                                                        <i class="fas fa-chart-bar"></i> Monthly
                                                                    </button>
                                                                </td>
                                                                {% endif %}
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Unverified Species Counts (Admin Only) -->
                                {% if is_admin and unverified_counts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm border-warning">
                                            <div class="card-header bg-warning text-dark">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>Unverified Species Counts - Pending Review
                                                </h5>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Species</th>
                                                                <th class="text-center">Total Count</th>
                                                                <th class="text-center">Observations</th>
                                                                <th class="text-center">Last Seen</th>
                                                                <th class="text-center">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for species_count in unverified_counts %}
                                                            <tr>
                                                                <td>
                                                                    <strong class="text-warning">{{ species_count.species.name }}</strong>
                                                                    <br><small class="text-muted">{{ species_count.species.scientific_name }}</small>
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge bg-warning text-dark fs-6">{{ species_count.total_count }}</span>
                                                                </td>
                                                                <td class="text-center">{{ species_count.observation_count }}</td>
                                                                <td class="text-center">
                                                                    {% if species_count.last_observation_date %}
                                                                    {{ species_count.last_observation_date|date:"M d, Y" }}
                                                                    {% else %}
                                                                    <span class="text-muted">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    <form method="post" action="{% url 'locations:verify_species_count' species_count.id %}" style="display:inline;">
                                                                        {% csrf_token %}
                                                                        <button type="submit" class="btn btn-sm btn-success">
                                                                            <i class="fas fa-check"></i> Verify
                                                                        </button>
                                                                    </form>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Analytics Tab -->
                        <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
                            <div class="p-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-chart-line me-2"></i>Site Analytics & Trends
                                </h5>

                                <!-- Site Statistics Summary -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-chart-bar me-2"></i>Site Statistics Summary
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                {% if site_stats %}
                                                <div class="row text-center g-4">
                                                    <div class="col-md-3">
                                                        <div class="p-3 bg-light rounded">
                                                            <h4 class="text-primary mb-2">{{ site_stats.total_census_records }}</h4>
                                                            <small class="text-muted">Total Census Records</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="p-3 bg-light rounded">
                                                            <h4 class="text-success mb-2">{{ site_stats.total_species_ever }}</h4>
                                                            <small class="text-muted">Species Ever Observed</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="p-3 bg-light rounded">
                                                            <h4 class="text-info mb-2">{{ site_stats.total_birds_ever }}</h4>
                                                            <small class="text-muted">Total Birds Ever</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="p-3 bg-light rounded">
                                                            <h4 class="text-warning mb-2">
                                                                {% if site_stats.first_observation %}
                                                                    {{ site_stats.first_observation|date:"M Y" }}
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            </h4>
                                                            <small class="text-muted">First Observation</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% else %}
                                                <div class="text-center py-4 text-muted">
                                                    <i class="fas fa-chart-line fa-2x mb-3"></i>
                                                    <p>No statistical data available yet.</p>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Yearly Data Aggregation -->
                                {% if yearly_totals %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-calendar-alt me-2"></i>Historical Data Summary by Year
                                                </h5>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="row">
                                                    {% for year, year_data in yearly_totals.items %}
                                                    <div class="col-lg-6 col-xl-4 mb-4">
                                                        <div class="card border-0 bg-gradient-primary text-white h-100">
                                                            <div class="card-body p-4">
                                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                                    <h4 class="mb-0">{{ year }}</h4>
                                                                    <i class="fas fa-calendar-alt fa-2x opacity-75"></i>
                                                                </div>

                                                                <div class="row text-center g-3">
                                                                    <div class="col-4">
                                                                        <div class="p-2 bg-white bg-opacity-25 rounded">
                                                                            <h5 class="mb-1">{{ year_data.total_species }}</h5>
                                                                            <small class="opacity-75">Species</small>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <div class="p-2 bg-white bg-opacity-25 rounded">
                                                                            <h5 class="mb-1">{{ year_data.total_birds }}</h5>
                                                                            <small class="opacity-75">Total Birds</small>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <div class="p-2 bg-white bg-opacity-25 rounded">
                                                                            <h5 class="mb-1">{{ year_data.census_count }}</h5>
                                                                            <small class="opacity-75">Observations</small>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Monthly breakdown -->
                                                                <div class="mt-3">
                                                                    <small class="opacity-75">Monthly Breakdown:</small>
                                                                    <div class="row g-1 mt-2">
                                                                        {% for month_num, month_data in year_data.months.items %}
                                                                        <div class="col-4">
                                                                            <div class="text-center p-1 bg-white bg-opacity-10 rounded">
                                                                                <small class="d-block opacity-75">
                                                                                    {% if month_num == 1 %}Jan
                                                                                    {% elif month_num == 2 %}Feb
                                                                                    {% elif month_num == 3 %}Mar
                                                                                    {% elif month_num == 4 %}Apr
                                                                                    {% elif month_num == 5 %}May
                                                                                    {% elif month_num == 6 %}Jun
                                                                                    {% elif month_num == 7 %}Jul
                                                                                    {% elif month_num == 8 %}Aug
                                                                                    {% elif month_num == 9 %}Sep
                                                                                    {% elif month_num == 10 %}Oct
                                                                                    {% elif month_num == 11 %}Nov
                                                                                    {% elif month_num == 12 %}Dec
                                                                                    {% endif %}
                                                                                </small>
                                                                                <small class="d-block fw-bold">{{ month_data.total_birds }}</small>
                                                                            </div>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Monthly Trend Chart -->
                                {% if monthly_data %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-info text-white">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-chart-line me-2"></i>Monthly Bird Count Trend (Last 12 Months)
                                                </h5>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="p-3 bg-light rounded">
                                                    <canvas id="monthlyTrendChart" style="height: 200px;"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Settings Tab (Admin Only) -->
                        {% if is_admin %}
                        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                            <div class="p-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-cog me-2"></i>Site Administration
                                </h5>

                                <!-- Site Configuration -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-secondary text-white">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-wrench me-2"></i>Site Configuration
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="d-flex align-items-center p-3 bg-light rounded">
                                                            <i class="fas fa-tag text-info me-3"></i>
                                                            <div>
                                                                <small class="text-muted d-block">Site Type</small>
                                                                <span class="badge bg-info fs-6">{{ site.get_site_type_display }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="d-flex align-items-center p-3 bg-light rounded">
                                                            <i class="fas fa-circle text-{% if site.status == 'active' %}success{% elif site.status == 'monitoring' %}warning{% else %}secondary{% endif %} me-3"></i>
                                                            <div>
                                                                <small class="text-muted d-block">Status</small>
                                                                <span class="badge bg-{% if site.status == 'active' %}success{% elif site.status == 'monitoring' %}warning{% else %}secondary{% endif %} fs-6">
                                                                    {{ site.get_status_display }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="d-flex align-items-center p-3 bg-light rounded">
                                                            <i class="fas fa-location-dot text-danger me-3"></i>
                                                            <div>
                                                                <small class="text-muted d-block">Coordinates</small>
                                                                <span class="{% if site.coordinates %}text-success{% else %}text-danger{% endif %}">
                                                                    {{ site.get_coordinates_display }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="d-flex align-items-center p-3 bg-light rounded">
                                                            <i class="fas fa-ruler-combined text-warning me-3"></i>
                                                            <div>
                                                                <small class="text-muted d-block">Area</small>
                                                                <span class="fw-bold">{{ site.area_hectares|default:"Not specified" }} ha</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="mt-4">
                                                    <a href="{% url 'locations:site_update' site.id %}" class="btn btn-primary">
                                                        <i class="fas fa-edit me-2"></i>Edit Site Information
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Management Actions -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-database me-2"></i>Data Management
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-4">
                                                        <a href="{% url 'locations:bulk_census_import_list' %}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                                            <i class="fas fa-file-import fa-3x mb-3 text-primary"></i>
                                                            <span class="fw-bold">Bulk Import</span>
                                                            <small class="opacity-75">Upload historical data</small>
                                                        </a>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <a href="{% url 'locations:census_export_csv' site.id %}" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                                            <i class="fas fa-file-export fa-3x mb-3 text-success"></i>
                                                            <span class="fw-bold">Export CSV</span>
                                                            <small class="opacity-75">Download census data</small>
                                                        </a>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <a href="{% url 'locations:census_export_excel' site.id %}" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                                            <i class="fas fa-file-excel fa-3x mb-3 text-info"></i>
                                                            <span class="fw-bold">Export Excel</span>
                                                            <small class="opacity-75">Download formatted data</small>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Census Modal -->
    {% if is_admin %}
    <div class="modal fade" id="addCensusModal" tabindex="-1" aria-labelledby="addCensusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCensusModalLabel">
                        <i class="fas fa-plus-circle text-success me-2"></i>Add New Census
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Select a site to add a new census observation for:</p>

                    <div class="list-group">
                        {% for site in all_sites %}
                        <a href="{% url 'locations:census_create' site.id %}" class="list-group-item list-group-item-action d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-map-marker-alt text-primary fa-lg"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">{{ site.name }}</div>
                                <div class="text-muted small">
                                    <span class="badge bg-info me-2">{{ site.get_site_type_display }}</span>
                                    {% if site.coordinates %}
                                        {{ site.get_coordinates_display }}
                                    {% else %}
                                        <span class="text-warning">Coordinates not set</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ site.created_at|date:"M d, Y" }}</small>
                            </div>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-center text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>No active sites available.</p>
                            <a href="{% url 'locations:site_create' %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-1"></i>Create First Site
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Individual Bird Records Modal -->
    <div class="modal fade" id="individualBirdsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-feather text-info me-2"></i>
                        Individual Bird Records
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="individualBirdsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading individual bird records...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editIndividualBirds()">
                        <i class="fas fa-edit me-2"></i>Edit Records
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script>
// Monthly Trend Chart
{% if monthly_data %}
const monthlyData = {{ monthly_data|safe }};
const monthLabels = Object.keys(monthlyData);
const monthValues = Object.values(monthlyData);

const ctx = document.getElementById('monthlyTrendChart');
if (ctx) {
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Total Birds',
                data: monthValues,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}
{% endif %}

// View Monthly Breakdown Modal
function viewMonthlyBreakdown(speciesCountId) {
    alert('Monthly breakdown view - Feature coming soon!');
    // TODO: Implement modal with detailed monthly/yearly breakdown
}

// Show Census Modal
function showCensusModal() {
    $('#addCensusModal').modal('show');
}

// View Individual Bird Records
function viewIndividualBirds(censusId) {
    // Show loading state
    $('#individualBirdsContent').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 mb-0">Loading individual bird records...</p>
        </div>
    `);

    // Fetch individual bird data via AJAX
    $.get(`/locations/api/census/${censusId}/individual-birds/`)
        .done(function(data) {
            let html = `
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6 class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Individual bird observations for this census
                        </h6>
                    </div>
                </div>
                <div class="row">
            `;

            if (data.species_observations && data.species_observations.length > 0) {
                data.species_observations.forEach(function(obs) {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-1 text-primary">${obs.species_name}</h6>
                                            <small class="text-muted">Scientific: ${obs.species_scientific_name || 'Not specified'}</small>
                                        </div>
                                        <span class="badge bg-success fs-6">${obs.count} birds</span>
                                    </div>
                                    ${obs.behavior_notes ? `
                                        <div class="mt-2 p-2 bg-white rounded">
                                            <small class="text-muted d-block">Notes:</small>
                                            <small class="text-dark">${obs.behavior_notes}</small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="col-12">
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>No individual bird records found for this census.</p>
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            $('#individualBirdsContent').html(html);
        })
        .fail(function() {
            $('#individualBirdsContent').html(`
                <div class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>Failed to load individual bird records.</p>
                </div>
            `);
        });

    $('#individualBirdsModal').modal('show');
}

// Edit Individual Bird Records
function editIndividualBirds() {
    // Redirect to census edit page where individual birds can be modified
    window.location.href = `/locations/census/${censusId}/update/`;
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
}

.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.btn {
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: translateY(-1px);
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}

.year-section:not(:last-child) {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 2rem;
}

.breadcrumb {
    background-color: #f8f9fa;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
}

.breadcrumb-item a {
    color: #007bff;
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: #0056b3;
    text-decoration: underline;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Add smooth scrolling for better UX
    $('a[href^="#"]').on('click', function(event) {
        var target = $(this.getAttribute('href'));
        if (target.length) {
            event.preventDefault();
            $('html, body').stop().animate({
                scrollTop: target.offset().top - 100
            }, 1000);
        }
    });

    // Add tooltips to action buttons
    $('[title]').tooltip();

    // Add loading states to action buttons
    $('.btn').on('click', function() {
        if (!$(this).hasClass('btn-outline-danger')) {
            $(this).addClass('disabled');
            $(this).html('<i class="fas fa-spinner fa-spin me-1"></i>Loading...');
        }
    });

    console.log('Enhanced site detail page loaded');
});
</script>
{% endblock %}

