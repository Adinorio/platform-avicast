{% extends 'base.html' %}
{% load static %}

{% block title %}Submit Mobile Data Import - AVICAST System{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5">
                        <i class="fas fa-upload text-primary"></i>
                        Submit Mobile Data Import
                    </h1>
                    <p class="lead text-muted">Submit observation data collected from mobile app</p>
                </div>
                <div>
                    <a href="{% url 'locations:mobile_import_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-mobile-alt"></i>
                        Mobile Data Import Form
                    </h5>
                </div>
                <div class="card-body p-4">
                    <!-- Instructions -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Instructions</h6>
                        <ul class="mb-0">
                            <li>Select the site where the observations were made</li>
                            <li>Enter the observation date</li>
                            <li>Provide weather conditions during observation</li>
                            <li>Add species observations with their counts</li>
                            <li>Submit for admin review and approval</li>
                        </ul>
                    </div>

                    <!-- Import Form -->
                    <form id="mobileImportForm">
                        {% csrf_token %}

                        <!-- Site Selection -->
                        <div class="mb-4">
                            <label for="siteSelect" class="form-label">
                                <i class="fas fa-map-marker-alt text-primary"></i>
                                Observation Site <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="siteSelect" required>
                                <option value="">Choose a site...</option>
                                {% for site in sites %}
                                <option value="{{ site.id }}" data-coordinates="{{ site.coordinates }}" data-type="{{ site.site_type }}">
                                    {{ site.name }} ({{ site.site_type }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the site where these observations were collected.</div>
                        </div>

                        <!-- Observation Date -->
                        <div class="mb-4">
                            <label for="observationDate" class="form-label">
                                <i class="fas fa-calendar text-primary"></i>
                                Observation Date <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" id="observationDate" required>
                            <div class="form-text">Date when the observations were made.</div>
                        </div>

                        <!-- Weather Conditions -->
                        <div class="mb-4">
                            <label for="weatherConditions" class="form-label">
                                <i class="fas fa-cloud-sun text-primary"></i>
                                Weather Conditions
                            </label>
                            <input type="text" class="form-control" id="weatherConditions"
                                   placeholder="e.g., Sunny, 25Â°C, Light breeze">
                            <div class="form-text">Describe the weather conditions during observation.</div>
                        </div>

                        <!-- Species Observations -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-paw text-primary"></i>
                                Species Observations <span class="text-danger">*</span>
                            </label>
                            <div id="speciesContainer">
                                <div class="species-observation mb-3">
                                    <div class="row align-items-end">
                                        <div class="col-md-5">
                                            <label class="form-label">Species Name</label>
                                            <input type="text" class="form-control species-name"
                                                   placeholder="e.g., Chinese Egret" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Count</label>
                                            <input type="number" class="form-control species-count"
                                                   min="1" placeholder="0" required>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Notes</label>
                                            <input type="text" class="form-control species-notes"
                                                   placeholder="Optional">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-species">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addSpecies">
                                <i class="fas fa-plus"></i> Add Species
                            </button>
                            <div class="form-text">Add all species observed at this site with their counts.</div>
                        </div>

                        <!-- Site Information Display -->
                        <div id="siteInfo" class="mb-4" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-info-circle"></i>
                                        Selected Site Information
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Site Type:</strong> <span id="siteType"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Coordinates:</strong> <span id="siteCoords"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane"></i>
                                Submit Import Request
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                <i class="fas fa-eraser"></i>
                                Clear Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Site selection change handler
    $('#siteSelect').change(function() {
        const selectedOption = $(this).find('option:selected');
        const siteType = selectedOption.data('type');
        const coordinates = selectedOption.data('coordinates');

        if ($(this).val()) {
            $('#siteType').text(siteType);
            $('#siteCoords').text(coordinates || 'Not specified');
            $('#siteInfo').show();
        } else {
            $('#siteInfo').hide();
        }
    });

    // Add species button handler
    $('#addSpecies').click(function() {
        addSpeciesObservation();
    });

    // Remove species button handler
    $(document).on('click', '.remove-species', function() {
        if ($('.species-observation').length > 1) {
            $(this).closest('.species-observation').remove();
        } else {
            alert('At least one species observation is required.');
        }
    });

    // Form submission handler
    $('#mobileImportForm').submit(function(e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        const formData = getFormData();

        // Submit the form
        $.ajax({
            url: '{% url "locations:submit_mobile_import" %}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRFToken', $('[name=csrfmiddlewaretoken]').val());
            },
            success: function(response) {
                if (response.success) {
                    alert('Import request submitted successfully!');
                    window.location.href = '{% url "locations:mobile_import_list" %}';
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr) {
                alert('Error submitting import: ' + xhr.responseText);
            }
        });
    });
});

function addSpeciesObservation() {
    const speciesHtml = `
        <div class="species-observation mb-3">
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Species Name</label>
                    <input type="text" class="form-control species-name"
                           placeholder="e.g., Chinese Egret" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Count</label>
                    <input type="number" class="form-control species-count"
                           min="1" placeholder="0" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-control species-notes"
                           placeholder="Optional">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-species">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    $('#speciesContainer').append(speciesHtml);
}

function validateForm() {
    const siteId = $('#siteSelect').val();
    const observationDate = $('#observationDate').val();

    if (!siteId) {
        alert('Please select a site.');
        return false;
    }

    if (!observationDate) {
        alert('Please enter the observation date.');
        return false;
    }

    // Validate species observations
    let hasValidSpecies = false;
    $('.species-observation').each(function() {
        const speciesName = $(this).find('.species-name').val();
        const speciesCount = $(this).find('.species-count').val();

        if (speciesName.trim() && speciesCount && speciesCount > 0) {
            hasValidSpecies = true;
        }
    });

    if (!hasValidSpecies) {
        alert('Please add at least one valid species observation.');
        return false;
    }

    return true;
}

function getFormData() {
    const speciesObservations = [];

    $('.species-observation').each(function() {
        const speciesName = $(this).find('.species-name').val().trim();
        const speciesCount = parseInt($(this).find('.species-count').val());
        const speciesNotes = $(this).find('.species-notes').val().trim();

        if (speciesName && speciesCount > 0) {
            speciesObservations.push({
                species_name: speciesName,
                count: speciesCount,
                behavior_notes: speciesNotes || ''
            });
        }
    });

    return {
        site_id: $('#siteSelect').val(),
        observation_date: $('#observationDate').val(),
        weather_conditions: $('#weatherConditions').val(),
        species_observations: speciesObservations
    };
}

function clearForm() {
    if (confirm('Are you sure you want to clear the form? All data will be lost.')) {
        $('#mobileImportForm')[0].reset();
        $('#speciesContainer').html(`
            <div class="species-observation mb-3">
                <div class="row align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Species Name</label>
                        <input type="text" class="form-control species-name"
                               placeholder="e.g., Chinese Egret" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Count</label>
                        <input type="number" class="form-control species-count"
                               min="1" placeholder="0" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-control species-notes"
                               placeholder="Optional">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-species">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `);
        $('#siteInfo').hide();
    }
}
</script>
{% endblock %}
