{% extends 'base.html' %}
{% load static %}

{% block title %}Submit Data Change Request - AVICAST System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-paper-plane text-success"></i>
                        Submit Data Change Request
                    </h2>
                    <p class="text-muted mb-0">Request permission to add or modify data</p>
                </div>
                <a href="{% url 'locations:request_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Requests
                </a>
            </div>

            <!-- Messages -->
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Request Form -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Request Details</h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="requestForm">
                        {% csrf_token %}

                        <!-- Request Type -->
                        <div class="mb-4">
                            <label for="request_type" class="form-label">
                                <strong>Request Type *</strong>
                            </label>
                            <select name="request_type" id="request_type" class="form-select" required>
                                <option value="">Select request type...</option>
                                {% for type_code, type_name in request_types %}
                                <option value="{{ type_code }}">{{ type_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choose what type of change you want to request</div>
                        </div>

                        <!-- Site Selection -->
                        <div class="mb-4">
                            <label for="site_id" class="form-label">
                                <strong>Site *</strong>
                            </label>
                            <select name="site_id" id="site_id" class="form-select" required>
                                <option value="">Select a site...</option>
                                {% for site in sites %}
                                <option value="{{ site.id }}">{{ site.name }} ({{ site.get_site_type_display }})</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the site this request relates to</div>
                        </div>

                        <!-- Dynamic Fields Container -->
                        <div id="dynamicFields"></div>

                        <!-- Reason for Request -->
                        <div class="mb-4">
                            <label for="reason" class="form-label">
                                <strong>Reason for Request *</strong>
                            </label>
                            <textarea name="reason" id="reason" class="form-control" rows="4" required
                                placeholder="Please explain why you are making this request. Provide as much detail as possible to help admins review your request."></textarea>
                            <div class="form-text">Detailed explanations help admins review your request faster</div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'locations:request_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0 text-white"><i class="fas fa-question-circle me-2"></i>How It Works</h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2"><strong>Select Request Type:</strong> Choose what you want to do (add, edit, or delete data)</li>
                        <li class="mb-2"><strong>Select Site:</strong> Choose which site the request relates to</li>
                        <li class="mb-2"><strong>Fill Details:</strong> Provide the specific data for your request</li>
                        <li class="mb-2"><strong>Explain Reason:</strong> Tell admins why you're making this request</li>
                        <li class="mb-2"><strong>Submit:</strong> Your request will be sent to admins for review</li>
                        <li><strong>Track Status:</strong> Check the requests list to see when it's approved</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Species list for dynamic forms
const speciesList = [
    {% for species in species_list %}
    {id: '{{ species.id }}', name: '{{ species.name }}', scientific: '{{ species.scientific_name }}'},
    {% endfor %}
];

// Handle request type change
document.getElementById('request_type').addEventListener('change', function() {
    const requestType = this.value;
    const dynamicFields = document.getElementById('dynamicFields');
    dynamicFields.innerHTML = '';

    if (requestType === 'add_census') {
        dynamicFields.innerHTML = `
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <h6 class="card-title">Census Observation Details</h6>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Observation Date *</strong></label>
                        <input type="date" name="observation_date" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Weather Conditions</strong></label>
                        <input type="text" name="weather_conditions" class="form-control" placeholder="e.g., Sunny, Partly cloudy">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Notes</strong></label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>

                    <hr>
                    
                    <h6>Species Observations (Coming Soon)</h6>
                    <p class="text-muted small mb-0">Note: For now, species will need to be added separately after census creation. This feature is being developed.</p>
                    <input type="hidden" name="species_count" value="0">
                </div>
            </div>
        `;
    } else if (requestType === 'edit_site') {
        dynamicFields.innerHTML = `
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <h6 class="card-title">Site Information to Update</h6>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Site Name</strong></label>
                        <input type="text" name="site_name" class="form-control" placeholder="New site name">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Description</strong></label>
                        <textarea name="description" class="form-control" rows="3" placeholder="Updated description"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Coordinates</strong></label>
                        <input type="text" name="coordinates" class="form-control" placeholder="latitude, longitude">
                        <small class="form-text text-muted">Format: 14.5995, 120.9842</small>
                    </div>
                </div>
            </div>
        `;
    } else if (requestType === 'add_species') {
        let speciesOptions = '<option value="">Select species...</option>';
        speciesList.forEach(sp => {
            speciesOptions += `<option value="${sp.id}">${sp.name} - ${sp.scientific}</option>`;
        });

        dynamicFields.innerHTML = `
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <h6 class="card-title">Species to Add</h6>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Species *</strong></label>
                        <select name="species_id" class="form-select" required>
                            ${speciesOptions}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Count *</strong></label>
                        <input type="number" name="count" class="form-control" min="1" value="1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Behavior Notes</strong></label>
                        <textarea name="behavior_notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
        `;
    } else if (requestType) {
        dynamicFields.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>
                This request type is available. Please fill in the reason field with detailed information about what you want to change.
            </div>
        `;
    }
});
</script>
{% endblock %}




