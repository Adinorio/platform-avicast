{% extends 'base.html' %}
{% load static %}

{% block title %}Chart Gallery - AVICAST Analytics{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5">
                        <i class="fas fa-chart-bar text-primary"></i>
                        Chart Gallery
                    </h1>
                    <p class="lead text-muted">Explore interactive visualizations of your biodiversity data</p>
                </div>
                <a href="{% url 'analytics:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Chart Grid -->
    <div class="row">
        {% for chart in chart_types %}
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-{{ chart.type }} text-primary"></i>
                        {{ chart.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">{{ chart.description }}</p>

                    <!-- Chart Container -->
                    <div id="chart{{ forloop.counter }}" class="chart-container" style="height: 400px;">
                        <div class="text-center py-5">
                            <i class="fas fa-chart-{{ chart.type }} fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Click to load chart</p>
                            <button class="btn btn-primary btn-sm load-chart-btn"
                                    data-chart-endpoint="{% url chart.endpoint %}">
                                <i class="fas fa-play"></i> Load Chart
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-chart-{{ chart.type }}"></i>
                            {{ chart.type|title }} Chart
                        </small>
                        <button class="btn btn-outline-primary btn-sm download-chart-btn"
                                data-chart-id="chart{{ forloop.counter }}"
                                style="display: none;">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Chart Controls -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs text-secondary"></i>
                        Chart Controls
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-success w-100 mb-2" id="loadAllCharts">
                                <i class="fas fa-play"></i> Load All Charts
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-info w-100 mb-2" id="refreshCharts">
                                <i class="fas fa-sync-alt"></i> Refresh Charts
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning w-100 mb-2" id="downloadAllCharts">
                                <i class="fas fa-download"></i> Download All
                            </button>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'analytics:generate_census_report' %}" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-file-pdf"></i> Generate Report
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info"></i>
                        About These Charts
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Interactive Features:</h6>
                            <ul class="small text-muted">
                                <li><strong>Zoom:</strong> Click and drag to zoom into specific areas</li>
                                <li><strong>Pan:</strong> Click and drag to move around the chart</li>
                                <li><strong>Hover:</strong> Hover over data points for detailed information</li>
                                <li><strong>Legend:</strong> Click legend items to show/hide data series</li>
                                <li><strong>Download:</strong> Save charts as PNG images</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Data Sources:</h6>
                            <ul class="small text-muted">
                                <li><strong>Real-time:</strong> Charts update with your latest census data</li>
                                <li><strong>Filtered:</strong> Data is filtered by your access permissions</li>
                                <li><strong>Aggregated:</strong> Large datasets are summarized for performance</li>
                                <li><strong>Validated:</strong> Only validated census data is included</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
$(document).ready(function() {
    // Load chart when button is clicked
    $('.load-chart-btn').click(function() {
        const btn = $(this);
        const chartContainer = btn.closest('.chart-container');
        const endpoint = btn.data('chart-endpoint');

        // Show loading state
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');

        // Load chart data
        $.get(endpoint)
            .done(function(data) {
                if (data.chart) {
                    const chartData = JSON.parse(data.chart);
                    Plotly.newPlot(chartContainer.attr('id'), chartData.data, chartData.layout);

                    // Show download button
                    btn.closest('.card').find('.download-chart-btn').show();

                    // Hide load button
                    btn.hide();
                }
            })
            .fail(function() {
                chartContainer.html('<p class="text-danger text-center py-5">Failed to load chart</p>');
            });
    });

    // Load all charts
    $('#loadAllCharts').click(function() {
        $('.load-chart-btn').click();
    });

    // Refresh all charts
    $('#refreshCharts').click(function() {
        location.reload();
    });

    // Download chart
    $('.download-chart-btn').click(function() {
        const chartId = $(this).data('chart-id');
        Plotly.downloadImage(chartId, {
            format: 'png',
            filename: chartId + '_chart',
            height: 600,
            width: 800
        });
    });

    // Download all charts
    $('#downloadAllCharts').click(function() {
        $('.download-chart-btn').each(function() {
            if ($(this).is(':visible')) {
                $(this).click();
            }
        });
    });
});
</script>
{% endblock %}
