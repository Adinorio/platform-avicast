{% extends 'base.html' %}
{% load static %}

{% block title %}{{ image_upload.title|default:image_upload.original_filename }} - Image Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2 mb-0">
                    <i class="fas fa-image me-2"></i>Image Details
                </h1>
                <div>
                    <a href="{% url 'image_processing:list' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>Back to List
                    </a>
                    <a href="{% url 'image_processing:upload' %}" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload More
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Image Display -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-image me-2"></i>Image with Detection Results
                    </h5>
                </div>
                <div class="card-body">
                    {% if image_upload.image_file %}
                        <div class="position-relative" style="display: inline-block;" id="detectionContainer">
                            <img src="{{ image_upload.image_file.url }}" 
                                 class="img-fluid rounded detection-image" 
                                 alt="{{ image_upload.title|default:image_upload.original_filename }}"
                                 id="detectionImage">
                            
                            <!-- Display detection bounding boxes -->
                            {% if image_upload.processing_result and image_upload.processing_result.bounding_box %}
                                {% if image_upload.processing_result.bounding_box.all_detections %}
                                    {% for detection in image_upload.processing_result.bounding_box.all_detections %}
                                        <div class="bounding-box" 
                                             data-x="{{ detection.bounding_box.x|floatformat:0 }}"
                                             data-y="{{ detection.bounding_box.y|floatformat:0 }}"
                                             data-width="{{ detection.bounding_box.width|floatformat:0 }}"
                                             data-height="{{ detection.bounding_box.height|floatformat:0 }}"
                                             data-detection-id="detection-{{ forloop.counter }}">
                                            <div class="detection-label">
                                                {{ detection.species|default:"Bird" }} ({{ detection.confidence|floatformat:1 }}%)
                                            </div>
                                            <div class="detection-number" data-detection-id="detection-{{ forloop.counter }}">
                                                #{{ forloop.counter }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% elif image_upload.processing_result.bounding_box.best_detection %}
                                    <!-- Fallback to old format -->
                                    <div class="bounding-box fallback-box" 
                                         data-x="{{ image_upload.processing_result.bounding_box.best_detection.x|floatformat:0 }}"
                                         data-y="{{ image_upload.processing_result.bounding_box.best_detection.y|floatformat:0 }}"
                                         data-width="{{ image_upload.processing_result.bounding_box.best_detection.width|floatformat:0 }}"
                                         data-height="{{ image_upload.processing_result.bounding_box.best_detection.height|floatformat:0 }}"
                                         data-detection-id="detection-1">
                                        <div class="detection-label">
                                            {{ image_upload.processing_result.detected_species|default:"Bird" }}
                                        </div>
                                        <div class="detection-number" data-detection-id="detection-1">
                                            #1
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- Detection Results Summary -->
                        {% if image_upload.processing_result %}
                            <div class="mt-3">
                                <!-- User Feedback Section -->
                                {% if image_upload.processing_result.bounding_box.user_feedback %}
                                    {% with feedback=image_upload.processing_result.bounding_box.user_feedback %}
                                        <div class="alert alert-{{ feedback.severity|lower|default:'info' }} mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <span style="font-size: 1.5rem;">{{ feedback.icon|default:"‚ÑπÔ∏è" }}</span>
                                                </div>
                                                <div>
                                                    <h6 class="alert-heading mb-1">
                                                        {{ feedback.title|default:"Detection Information" }}
                                                    </h6>
                                                    <p class="mb-2">{{ feedback.message|default:"" }}</p>
                                                    {% if feedback.user_guidance %}
                                                        <div class="small">
                                                            <strong>Suggestions:</strong>
                                                            <ul class="mb-0 mt-1">
                                                                {% for suggestion in feedback.user_guidance %}
                                                                    <li>{{ suggestion }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endwith %}
                                {% endif %}

                                <!-- Technical Results -->
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-search me-2"></i>Detection Results
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <strong>Species:</strong><br>
                                            <span class="badge bg-primary fs-6">
                                                {{ image_upload.processing_result.detected_species|default:"Unknown" }}
                                            </span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Confidence:</strong><br>
                                            <span class="badge bg-success fs-6">
                                                {{ image_upload.processing_result.confidence_score|floatformat:1|default:"N/A" }}%
                                            </span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Birds Detected:</strong><br>
                                            <span class="badge bg-info fs-6">
                                                {{ image_upload.processing_result.total_detections|default:"0" }}
                                            </span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Model:</strong><br>
                                            <small>{{ image_upload.processing_result.ai_model|default:"N/A" }}</small>
                                        </div>
                                    </div>

                                    <!-- Additional Technical Details -->
                                    {% if image_upload.processing_result.bounding_box.user_feedback.technical_details %}
                                        <hr>
                                        <div class="small text-muted">
                                            <strong>Technical Details:</strong>
                                            <ul class="mb-0 mt-2">
                                                {% for key, value in image_upload.processing_result.bounding_box.user_feedback.technical_details.items %}
                                                    <li><strong>{{ key|title }}:</strong> {{ value }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-image fa-4x text-muted mb-3"></i>
                            <p class="text-muted">Image file not available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Image Information -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Image Information
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Title:</dt>
                        <dd class="col-sm-8">{{ image_upload.title|default:"Untitled" }}</dd>
                        
                        <dt class="col-sm-4">Filename:</dt>
                        <dd class="col-sm-8">{{ image_upload.original_filename }}</dd>
                        
                        <dt class="col-sm-4">Description:</dt>
                        <dd class="col-sm-8">{{ image_upload.description|default:"No description" }}</dd>
                        
                        <dt class="col-sm-4">Status:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-{{ image_upload.upload_status|lower }}">
                                {{ image_upload.get_upload_status_display }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-4">Uploaded:</dt>
                        <dd class="col-sm-8">{{ image_upload.uploaded_at|date:"M d, Y H:i" }}</dd>
                        
                        <dt class="col-sm-4">File Size:</dt>
                        <dd class="col-sm-8">{{ image_upload.file_size|filesizeformat }}</dd>
                        
                        <dt class="col-sm-4">File Type:</dt>
                        <dd class="col-sm-8">{{ image_upload.file_type }}</dd>
                        
                        {% if image_upload.is_compressed %}
                        <dt class="col-sm-4">Compressed:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-success">Yes</span>
                            {% if image_upload.compressed_size %}
                                ({{ image_upload.compressed_size|filesizeformat }})
                            {% endif %}
                        </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Actions -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body">
                    {% if image_upload.upload_status == 'UPLOADED' %}
                        <a href="{% url 'image_processing:process_batch' image_upload.pk %}" 
                           class="btn btn-success w-100 mb-2">
                            <i class="fas fa-play me-2"></i>Process Image
                        </a>
                    {% endif %}
                    
                    <!-- Ground Truth Annotation Button -->
                    <a href="{% url 'image_processing:annotate' image_upload.pk %}" 
                       class="btn btn-warning w-100 mb-2">
                        <i class="fas fa-pencil-alt me-2"></i>Create Ground Truth Annotations
                    </a>
                    {% if image_upload.metadata and image_upload.metadata.ground_truth_annotations %}
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Ground truth available:</strong> 
                            {{ image_upload.metadata.ground_truth_annotations|length }} annotations
                            <br><small class="text-muted">
                                Created by {{ image_upload.metadata.annotation_created_by }} 
                                on {{ image_upload.metadata.annotation_created_at|date:"M d, Y H:i" }}
                            </small>
                        </div>
                    {% endif %}
                    
                    {% if image_upload.upload_status == 'PROCESSED' %}
                        <a href="{% url 'image_processing:review' %}" 
                           class="btn btn-warning w-100 mb-2">
                            <i class="fas fa-eye me-2"></i>Review Results
                        </a>
                    {% endif %}
                    
                    <a href="{% url 'image_processing:list' %}" 
                       class="btn btn-outline-primary w-100">
                        <i class="fas fa-list me-2"></i>View All Images
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Controls -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-eye me-2"></i>Display Controls
                    </h6>
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleBoundingBoxes" checked>
                            <label class="form-check-label" for="toggleBoundingBoxes">
                                <i class="fas fa-vector-square me-1"></i>Bounding Boxes
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleNumbers" checked>
                            <label class="form-check-label" for="toggleNumbers">
                                <i class="fas fa-hashtag me-1"></i>Detection Numbers
                            </label>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        üí° <strong>Tip:</strong> Hover over any bounding box or number to see detection labels.
                        <br>‚Ä¢ Toggle off boxes to see just numbers (identifiers)
                        <br>‚Ä¢ Numbers stay visible even when boxes are hidden
                        <br>‚Ä¢ Use toggles to customize your view
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.position-relative {
    position: relative;
    display: inline-block;
    max-width: 100%;
}

.detection-image {
    max-width: 100%;
    height: auto;
    display: block;
}

.bounding-box {
    position: absolute;
    border: 3px solid #ff0000;
    background: rgba(255, 0, 0, 0.1);
    pointer-events: all;
    box-sizing: border-box;
    z-index: 10;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.bounding-box:hover {
    border-color: #ff4444;
    background: rgba(255, 0, 0, 0.15);
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.3);
}

.detection-label {
    position: absolute;
    top: -30px;
    left: 0;
    background: #ff0000;
    color: white;
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    font-weight: bold;
    white-space: nowrap;
    z-index: 15;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}

/* Hover effects for labels - show on bounding box or number hover */
.bounding-box:hover .detection-label,
.detection-number:hover .detection-label {
    opacity: 1;
}

/* Toggle states - use visibility to maintain position context */
.bounding-box.hidden { visibility: hidden; }
.bounding-box.hidden .detection-number { visibility: visible !important; }
.detection-number.hidden { display: none; }

.detection-number {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #000000;
    color: white;
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 3px;
    font-weight: bold;
    z-index: 15;
    border: 2px solid #ff0000;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    min-width: 20px;
    text-align: center;
}

/* Ensure proper stacking context */
.card-img-top-container {
    position: relative;
    overflow: hidden;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const detectionImage = document.getElementById('detectionImage');
    const boundingBoxes = document.querySelectorAll('.bounding-box');

    if (detectionImage && boundingBoxes.length > 0) {
        // Wait for image to load to get accurate dimensions
        detectionImage.addEventListener('load', function() {
            positionBoundingBoxes();
        });

        // If image is already loaded
        if (detectionImage.complete) {
            positionBoundingBoxes();
        }
    }

    function positionBoundingBoxes() {
        const img = document.getElementById('detectionImage');
        const imgRect = img.getBoundingClientRect();

        // Get original image dimensions from naturalWidth/naturalHeight
        const originalWidth = img.naturalWidth;
        const originalHeight = img.naturalHeight;

        // Get displayed image dimensions
        const displayedWidth = imgRect.width;
        const displayedHeight = imgRect.height;

        // Calculate scaling ratios
        const scaleX = displayedWidth / originalWidth;
        const scaleY = displayedHeight / originalHeight;

        console.log('Image scaling:', {
            original: {width: originalWidth, height: originalHeight},
            displayed: {width: displayedWidth, height: displayedHeight},
            scale: {x: scaleX, y: scaleY}
        });
    
    boundingBoxes.forEach(function(box) {
        const x = parseInt(box.dataset.x);
        const y = parseInt(box.dataset.y);
        const width = parseInt(box.dataset.width);
        const height = parseInt(box.dataset.height);
        
        if (!isNaN(x) && !isNaN(y) && !isNaN(width) && !isNaN(height)) {
                // Scale the coordinates based on the displayed image size
                const scaledX = x * scaleX;
                const scaledY = y * scaleY;
                const scaledWidth = width * scaleX;
                const scaledHeight = height * scaleY;

                box.style.left = scaledX + 'px';
                box.style.top = scaledY + 'px';
                box.style.width = scaledWidth + 'px';
                box.style.height = scaledHeight + 'px';

                console.log('Bounding box positioned:', {
                    original: {x, y, width, height},
                    scaled: {x: scaledX, y: scaledY, width: scaledWidth, height: scaledHeight}
                });
            }
        });

        // Handle overlapping detection numbers
        setTimeout(() => {
            preventNumberOverlaps();
        }, 10);
    }

    function preventNumberOverlaps() {
        const numbers = document.querySelectorAll('.detection-number');
        const numberData = [];

        // Collect position data for all numbers
        numbers.forEach((number, index) => {
            const rect = number.getBoundingClientRect();
            const parentRect = number.closest('.position-relative, .card-img-top-container').getBoundingClientRect();

            numberData.push({
                element: number,
                index: index,
                x: rect.left - parentRect.left,
                y: rect.top - parentRect.top,
                width: rect.width,
                height: rect.height,
                originalX: rect.left - parentRect.left,
                originalY: rect.top - parentRect.top
            });
        });

        // Check for overlaps and reposition
        numberData.forEach((number, index) => {
            let overlaps = false;
            let attempts = 0;
            const maxAttempts = 4;

            while (attempts < maxAttempts) {
                overlaps = false;

                // Check overlap with other numbers
                for (let i = 0; i < numberData.length; i++) {
                    if (i === index) continue;

                    if (rectsOverlap(number, numberData[i])) {
                        overlaps = true;
                        break;
                    }
                }

                if (!overlaps) break;

                // Try different positions
                attempts++;
                switch (attempts) {
                    case 1: // Move to top-left
                        number.element.style.top = '5px';
                        number.element.style.right = 'auto';
                        number.element.style.left = '5px';
                        break;
                    case 2: // Move to bottom-right
                        number.element.style.top = 'auto';
                        number.element.style.right = '5px';
                        number.element.style.bottom = '5px';
                        number.element.style.left = 'auto';
                        break;
                    case 3: // Move to bottom-left
                        number.element.style.top = 'auto';
                        number.element.style.right = 'auto';
                        number.element.style.bottom = '5px';
                        number.element.style.left = '5px';
                        break;
                    case 4: // Move outside box (top)
                        number.element.style.top = '-25px';
                        number.element.style.right = '5px';
                        number.element.style.bottom = 'auto';
                        number.element.style.left = 'auto';
                        number.element.style.background = '#ff0000';
                        number.element.style.border = '2px solid #000000';
                        break;
                }

                // Update position data
                const rect = number.element.getBoundingClientRect();
                const parentRect = number.element.closest('.position-relative, .card-img-top-container').getBoundingClientRect();
                number.x = rect.left - parentRect.left;
                number.y = rect.top - parentRect.top;
            }
        });
    }

    function rectsOverlap(rect1, rect2) {
    const padding = 5; // Add some padding to prevent too-close positioning
    return !(rect1.x + rect1.width + padding < rect2.x ||
             rect2.x + rect2.width + padding < rect1.x ||
             rect1.y + rect1.height + padding < rect2.y ||
             rect2.y + rect2.height + padding < rect1.y);
}

// Toggle functionality
function setupToggles() {
    console.log('Setting up toggles...');

    const toggleBoundingBoxes = document.getElementById('toggleBoundingBoxes');
    const toggleNumbers = document.getElementById('toggleNumbers');

    console.log('Toggle elements found:', {
        boundingBoxes: !!toggleBoundingBoxes,
        numbers: !!toggleNumbers
    });

    // Bounding boxes toggle
    if (toggleBoundingBoxes) {
        toggleBoundingBoxes.addEventListener('change', function() {
            console.log('Bounding boxes toggle clicked:', this.checked);
            try {
                const boxes = document.querySelectorAll('.bounding-box');
                console.log('Found bounding boxes:', boxes.length);

                boxes.forEach((box, index) => {
                    if (this.checked) {
                        box.style.visibility = 'visible';
                        box.classList.remove('hidden');
                        console.log(`Box ${index}: shown`);
                    } else {
                        box.style.visibility = 'hidden';
                        box.classList.add('hidden');
                        console.log(`Box ${index}: hidden (numbers stay positioned)`);
                    }
                });
            } catch (error) {
                console.error('Error toggling bounding boxes:', error);
            }
        });
        console.log('‚úÖ Bounding boxes toggle listener attached');
    } else {
        console.error('‚ùå Bounding boxes toggle element not found');
    }

    // Numbers toggle
    if (toggleNumbers) {
        toggleNumbers.addEventListener('change', function() {
            console.log('Numbers toggle clicked:', this.checked);
            try {
                const numbers = document.querySelectorAll('.detection-number');
                console.log('Found detection numbers:', numbers.length);

                numbers.forEach((number, index) => {
                    if (this.checked) {
                        number.style.display = 'block';
                        number.classList.remove('hidden');
                        console.log(`Number ${index}: shown`);
                    } else {
                        number.style.display = 'none';
                        number.classList.add('hidden');
                        console.log(`Number ${index}: hidden`);
                    }
                });
            } catch (error) {
                console.error('Error toggling numbers:', error);
            }
        });
        console.log('‚úÖ Numbers toggle listener attached');
    } else {
        console.error('‚ùå Numbers toggle element not found');
    }



    console.log('=== TOGGLE SETUP COMPLETE ===');
}

// Enhanced hover functionality for labels
function setupLabelHover() {
    const boundingBoxes = document.querySelectorAll('.bounding-box');
    const detectionNumbers = document.querySelectorAll('.detection-number');

    console.log('Setting up hover functionality...');
    console.log('Found bounding boxes:', boundingBoxes.length);
    console.log('Found detection numbers:', detectionNumbers.length);

    // Function to show label for a specific element
    function showLabel(targetElement) {
        // Hide all labels first
        document.querySelectorAll('.detection-label').forEach(label => {
            label.style.opacity = '0';
        });

        // Show the label within the same bounding box
        const parentBox = targetElement.closest('.bounding-box');
        if (parentBox) {
            const label = parentBox.querySelector('.detection-label');
            if (label) {
                label.style.opacity = '1';
            }
        }
    }

    // Function to hide all labels
    function hideLabels() {
        document.querySelectorAll('.detection-label').forEach(label => {
            label.style.opacity = '0';
        });
    }

    // Add hover listeners to bounding boxes
    boundingBoxes.forEach(box => {
        box.addEventListener('mouseenter', (e) => {
            console.log('Hovering over bounding box');
            showLabel(e.target);
        });
        box.addEventListener('mouseleave', hideLabels);
    });

    // Add hover listeners to detection numbers
    detectionNumbers.forEach(number => {
        number.addEventListener('mouseenter', (e) => {
            console.log('Hovering over detection number');
            showLabel(e.target);
        });
        number.addEventListener('mouseleave', hideLabels);
    });
}

// Initialize everything immediately and on DOM ready
console.log('=== SCRIPT LOADED - Starting Immediate Setup ===');

// Try immediate setup first
try {
    setupToggles();
    setupLabelHover();
    console.log('=== IMMEDIATE SETUP COMPLETE ===');
} catch (error) {
    console.error('Immediate setup failed:', error);
}

// Also setup when DOM is ready (backup)
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== PAGE LOADED - DOM Ready Setup ===');

    try {
        setupToggles();
        setupLabelHover();

        console.log('=== DOM READY SETUP COMPLETE ===');
        console.log('Testing element selection...');

        // Test if elements exist
        const boxes = document.querySelectorAll('.bounding-box');
        const numbers = document.querySelectorAll('.detection-number');
        const labels = document.querySelectorAll('.detection-label');

        console.log('Bounding boxes found:', boxes.length);
        console.log('Detection numbers found:', numbers.length);
        console.log('Detection labels found:', labels.length);

        // Show some sample elements
        if (boxes.length > 0) {
            console.log('First bounding box:', boxes[0]);
            console.log('First bounding box classes:', boxes[0].classList);
        }

    } catch (error) {
        console.error('DOM Ready setup failed:', error);
    }
});

// Also try on window load
window.addEventListener('load', function() {
    console.log('=== WINDOW LOADED - Final Setup ===');
    try {
        setupToggles();
        setupLabelHover();
        console.log('=== WINDOW LOAD SETUP COMPLETE ===');
    } catch (error) {
        console.error('Window load setup failed:', error);
    }
});

// Manual test function that can be called from browser console
window.testDetectionElements = function() {
    console.log('=== MANUAL TEST ===');

    const boxes = document.querySelectorAll('.bounding-box');
    const numbers = document.querySelectorAll('.detection-number');
    const labels = document.querySelectorAll('.detection-label');

    console.log('Bounding boxes:', boxes.length);
    console.log('Detection numbers:', numbers.length);
    console.log('Detection labels:', labels.length);

    // Test hiding boxes
    console.log('Testing: Hide all bounding boxes');
    boxes.forEach(box => {
        box.style.visibility = 'hidden';
        console.log('Hidden box:', box);
    });

    // Test showing boxes after 2 seconds
    setTimeout(() => {
        console.log('Testing: Show all bounding boxes');
        boxes.forEach(box => {
            box.style.visibility = 'visible';
            console.log('Shown box:', box);
        });
    }, 2000);
};

});
</script>

{% endblock %}
