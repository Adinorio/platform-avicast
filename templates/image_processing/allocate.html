{% extends 'base.html' %}
{% load static %}

{% block title %}Allocate Results - Image Processing{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-share-alt me-2"></i>Allocate Results to Census Data
                </h1>
                <div>
                    <a href="{% url 'image_processing:review' %}" class="btn btn-outline-warning me-2">
                        <i class="fas fa-eye me-2"></i>Back to Review
                    </a>
                    <a href="{% url 'image_processing:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Dashboard
                    </a>
                </div>
            </div>

            {% if approved_results %}
                <div class="row">
                    <!-- Left Side: Approved Results -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle me-2"></i>Approved Results ({{ approved_results.count }})
                                </h5>
                                <small>Drag results to the right side to allocate them</small>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                <div class="row" id="approvedResultsContainer">
                                    {% for result in approved_results %}
                                    <div class="col-12 mb-3">
                                        <div class="card draggable-result"
                                             draggable="true"
                                             data-result-id="{{ result.pk }}"
                                             data-species="{{ result.final_species }}"
                                             data-confidence="{{ result.confidence_score }}">
                                            <div class="card-body p-3">
                                                <div class="row align-items-center">
                                                    <div class="col-3">
                                                        {% if result.image_upload.image_file %}
                                                            <img src="{{ result.image_upload.image_file.url }}"
                                                                 class="img-fluid rounded"
                                                                 alt="{{ result.image_upload.title }}"
                                                                 style="max-height: 80px; width: auto;">
                                                        {% else %}
                                                            <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                                                 style="height: 80px; width: 80px;">
                                                                <i class="fas fa-image fa-2x text-muted"></i>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-9">
                                                        <h6 class="mb-1">{{ result.image_upload.title|default:"Untitled" }}</h6>
                                                        <div class="row text-muted small">
                                                            <div class="col-6">
                                                                <strong>Species:</strong> {{ result.final_species|default:"Unknown" }}
                                                            </div>
                                                            <div class="col-6">
                                                                <strong>Confidence:</strong> {{ result.confidence_score|default:"N/A" }}%
                                                            </div>
                                                        </div>
                                                        <div class="row text-muted small">
                                                            <div class="col-6">
                                                                <strong>Status:</strong>
                                                                {% if result.review_status == 'APPROVED' %}
                                                                    <span class="badge bg-success">Approved</span>
                                                                {% else %}
                                                                    <span class="badge bg-info">Overridden</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-6">
                                                                <strong>Date:</strong> {{ result.created_at|date:"M d, Y" }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Allocation Targets -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-map-marker-alt me-2"></i>Census Allocation Targets
                                </h5>
                                <small>Drop results here to allocate them</small>
                            </div>
                            <div class="card-body">
                                <!-- Site Selection -->
                                <div class="mb-4">
                                    <label for="siteSelect" class="form-label">Select Site:</label>
                                    <select class="form-select" id="siteSelect">
                                        <option value="">Choose a site...</option>
                                        {% for site in sites %}
                                            <option value="{{ site.id }}">{{ site.name }} - {{ site.location }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Year Selection -->
                                <div class="mb-4">
                                    <label for="yearSelect" class="form-label">Select Year:</label>
                                    <select class="form-select" id="yearSelect">
                                        <option value="">Choose a year...</option>
                                        {% for year in years %}
                                            <option value="{{ year }}">{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Monthly Allocation Grid -->
                                <div class="mb-4">
                                    <label class="form-label">Monthly Allocation:</label>
                                    <div class="row g-2" id="monthlyAllocation">
                                        {% for month in months %}
                                        <div class="col-3">
                                            <div class="allocation-target text-center p-2 border rounded"
                                                 data-month="{{ month.id }}"
                                                 data-month-name="{{ month.name }}"
                                                 ondrop="drop(event)"
                                                 ondragover="allowDrop(event)">
                                                <div class="fw-bold">{{ month.abbr }}</div>
                                                <div class="small text-muted">Count: <span class="count-display">0</span></div>
                                                <div class="allocated-results" data-month="{{ month.id }}"></div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Allocation Summary -->
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Allocation Summary</h6>
                                        <div id="allocationSummary">
                                            <p class="text-muted mb-0">No results allocated yet. Drag and drop results to monthly targets.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-grid gap-2 mt-4">
                                    <button class="btn btn-success" onclick="saveAllocation()" id="saveBtn" disabled>
                                        <i class="fas fa-save me-2"></i>Save Allocation
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearAllocation()">
                                        <i class="fas fa-eraser me-2"></i>Clear All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                    <h4>No Approved Results to Allocate</h4>
                    <p class="text-muted">You need to approve some processing results first before you can allocate them.</p>
                    <a href="{% url 'image_processing:review' %}" class="btn btn-primary">
                        <i class="fas fa-eye me-2"></i>Go to Review
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let allocationData = {};

// Drag and drop functionality
function allowDrop(ev) {
    ev.preventDefault();
}

function drop(ev) {
    ev.preventDefault();
    const monthTarget = ev.target.closest('.allocation-target');
    if (!monthTarget) return;

    const resultId = ev.dataTransfer.getData("text");
    const resultElement = document.querySelector(`[data-result-id="${resultId}"]`);

    if (resultElement && monthTarget) {
        const monthId = monthTarget.dataset.month;
        const monthName = monthTarget.dataset.monthName;

        // Add to allocation data
        if (!allocationData[monthId]) {
            allocationData[monthId] = [];
        }

        // Check if result is already allocated
        const isAlreadyAllocated = Object.values(allocationData).flat().some(item => item.id === resultId);
        if (isAlreadyAllocated) {
            alert('This result is already allocated to another month!');
            return;
        }

        // Add result to allocation
        const resultData = {
            id: resultId,
            title: resultElement.querySelector('h6').textContent,
            species: resultElement.dataset.species,
            confidence: resultElement.dataset.confidence
        };

        allocationData[monthId].push(resultData);

        // Update display
        updateAllocationDisplay(monthId, monthName);
        updateAllocationSummary();
        updateSaveButton();
    }
}

// Update the visual display for a specific month
function updateAllocationDisplay(monthId, monthName) {
    const monthTarget = document.querySelector(`[data-month="${monthId}"]`);
    const countDisplay = monthTarget.querySelector('.count-display');
    const resultsContainer = monthTarget.querySelector('.allocated-results');

    const results = allocationData[monthId] || [];
    countDisplay.textContent = results.length;

    // Clear existing results
    resultsContainer.innerHTML = '';

    // Add result badges
    results.forEach(result => {
        const badge = document.createElement('div');
        badge.className = 'badge bg-primary me-1 mb-1';
        badge.textContent = result.species || 'Unknown';
        badge.title = result.title;
        resultsContainer.appendChild(badge);
    });
}

// Update the allocation summary
function updateAllocationSummary() {
    const summaryContainer = document.getElementById('allocationSummary');
    const totalAllocated = Object.values(allocationData).flat().length;

    if (totalAllocated === 0) {
        summaryContainer.innerHTML = '<p class="text-muted mb-0">No results allocated yet. Drag and drop results to monthly targets.</p>';
        return;
    }

    let summaryHTML = '<div class="row">';
    Object.keys(allocationData).forEach(monthId => {
        const monthName = document.querySelector(`[data-month="${monthId}"]`).dataset.monthName;
        const results = allocationData[monthId];
        if (results && results.length > 0) {
            summaryHTML += `
                <div class="col-6 mb-2">
                    <strong>${monthName}:</strong> ${results.length} result(s)
                </div>
            `;
        }
    });
    summaryHTML += '</div>';

    summaryContainer.innerHTML = summaryHTML;
}

// Update save button state
function updateSaveButton() {
    const saveBtn = document.getElementById('saveBtn');
    const totalAllocated = Object.values(allocationData).flat().length;
    saveBtn.disabled = totalAllocated === 0;
}

// Save allocation
function saveAllocation() {
    const siteId = document.getElementById('siteSelect').value;
    const year = document.getElementById('yearSelect').value;

    if (!siteId || !year) {
        alert('Please select both a site and year before saving.');
        return;
    }

    // Here you would send the allocation data to your backend
    console.log('Saving allocation:', {
        site_id: siteId,
        year: year,
        allocation: allocationData
    });

    // For now, just show a success message
    alert('Allocation saved successfully! This would integrate with your census data system.');
}

// Clear all allocations
function clearAllocation() {
    if (confirm('Are you sure you want to clear all allocations?')) {
        allocationData = {};

        // Reset all month displays
        document.querySelectorAll('.allocation-target').forEach(target => {
            const monthId = target.dataset.month;
            const countDisplay = target.querySelector('.count-display');
            const resultsContainer = target.querySelector('.allocated-results');

            countDisplay.textContent = '0';
            resultsContainer.innerHTML = '';
        });

        updateAllocationSummary();
        updateSaveButton();
    }
}

// Initialize drag and drop for result cards
document.addEventListener('DOMContentLoaded', function() {
    const resultCards = document.querySelectorAll('.draggable-result');

    resultCards.forEach(card => {
        card.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData("text", this.dataset.resultId);
            this.style.opacity = '0.5';
        });

        card.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
        });
    });
});
</script>

<!-- Add CSRF token for AJAX calls -->
{% csrf_token %}
{% endblock %}
