{% extends 'base.html' %}
{% load static %}

{% block title %}Model Performance Analytics - AviCast{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
<style>
    .analytics-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .analytics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .evaluation-form {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-analytics {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-analytics:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .recent-runs {
        max-height: 400px;
        overflow-y: auto;
    }

    .run-item {
        border-left: 4px solid #667eea;
        padding-left: 1rem;
        margin-bottom: 1rem;
        background: white;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-weight: 600;
    }

    .status-completed { background: #28a745; color: white; }
    .status-processing { background: #ffc107; color: #212529; }
    .status-failed { background: #dc3545; color: white; }
    .status-pending { background: #6c757d; color: white; }

    .species-chart-container {
        height: 300px;
        position: relative;
    }

    .filter-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">ü§ñ Model Performance Analytics</h1>
            <p class="text-muted mb-0">Advanced MLOps metrics for YOLO model comparison and thesis analysis</p>
        </div>
        <div>
            <a href="{% url 'image_processing:evaluation_runs_list' %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-list"></i> View All Runs
            </a>
            <a href="{% url 'image_processing:model_comparison' %}" class="btn btn-outline-success">
                <i class="fas fa-balance-scale"></i> Compare Models
            </a>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card analytics-card h-100 text-center p-3">
                <div class="metric-value">{{ total_processed_images }}</div>
                <div class="metric-label">Images Processed</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card analytics-card h-100 text-center p-3">
                <div class="metric-value">{{ total_approved_results }}</div>
                <div class="metric-label">Approved Results</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card analytics-card h-100 text-center p-3">
                <div class="metric-value">{{ available_models|length }}</div>
                <div class="metric-label">AI Models Available</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card analytics-card h-100 text-center p-3">
                <div class="metric-value">{{ recent_runs|length }}</div>
                <div class="metric-label">Recent Evaluations</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Evaluation Configuration -->
        <div class="col-lg-8">
            <div class="evaluation-form">
                <h3 class="mb-4">üéØ Create New Evaluation Run</h3>
                <p class="text-muted mb-4">Configure and execute a comprehensive model performance evaluation for your thesis analysis.</p>

                <form id="evaluationForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="runName" class="form-label fw-bold">Evaluation Name</label>
                            <input type="text" class="form-control" id="runName" placeholder="e.g., YOLOv8 vs YOLOv9 Comparison">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="runDescription" class="form-label fw-bold">Description</label>
                            <input type="text" class="form-control" id="runDescription" placeholder="Brief description of this evaluation">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ioUThreshold" class="form-label fw-bold">IoU Threshold</label>
                            <select class="form-select" id="ioUThreshold">
                                <option value="0.5" selected>0.5 (Standard)</option>
                                <option value="0.3">0.3 (Relaxed)</option>
                                <option value="0.7">0.7 (Strict)</option>
                                <option value="0.9">0.9 (Very Strict)</option>
                            </select>
                            <div class="form-text">Minimum IoU for True Positive classification</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="confidenceThreshold" class="form-label fw-bold">Confidence Threshold</label>
                            <select class="form-select" id="confidenceThreshold">
                                <option value="0.1">0.1 (Very Low)</option>
                                <option value="0.25" selected>0.25 (Standard)</option>
                                <option value="0.5">0.5 (Medium)</option>
                                <option value="0.7">0.7 (High)</option>
                            </select>
                            <div class="form-text">Minimum confidence for detections</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Models to Evaluate</label>
                            <div class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                                {% for model in available_models %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="{{ model }}" id="model_{{ forloop.counter }}" checked>
                                    <label class="form-check-label" for="model_{{ forloop.counter }}">
                                        {{ model }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Species to Include</label>
                            <div class="border rounded p-3">
                                {% for species in target_species %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="{{ species }}" id="species_{{ forloop.counter }}" checked>
                                    <label class="form-check-label" for="species_{{ forloop.counter }}">
                                        {{ species }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateStart" class="form-label fw-bold">Date Range Start (Optional)</label>
                            <input type="date" class="form-control" id="dateStart">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dateEnd" class="form-label fw-bold">Date Range End (Optional)</label>
                            <input type="date" class="form-control" id="dateEnd">
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-analytics btn-lg" id="startEvaluationBtn">
                            <i class="fas fa-rocket me-2"></i>Start Evaluation Run
                        </button>
                        <div id="submitStatus" class="mt-2" style="display: none;">
                            <small class="text-muted">Processing your request...</small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recent Runs & Statistics -->
        <div class="col-lg-4">
            <!-- Recent Evaluation Runs -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Evaluation Runs</h5>
                </div>
                <div class="card-body recent-runs">
                    {% for run in recent_runs %}
                    <div class="run-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">{{ run.name }}</h6>
                            <span class="status-badge status-{{ run.status|lower }}">{{ run.get_status_display }}</span>
                        </div>
                        <p class="text-muted small mb-2">{{ run.description|truncatechars:60 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ run.created_at|date:"M d, Y H:i" }}</small>
                            {% if run.status == 'COMPLETED' %}
                            <a href="{% url 'image_processing:evaluation_results' run.id %}" class="btn btn-sm btn-outline-primary">
                                View Results
                            </a>
                            {% endif %}
                        </div>
                        {% if run.status == 'COMPLETED' and run.overall_map_50 %}
                        <div class="mt-2">
                            <small class="text-success fw-bold">mAP@0.5: {{ run.overall_map_50|floatformat:3 }}</small>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-line fa-3x mb-3 opacity-50"></i>
                        <p>No evaluation runs yet.<br>Create your first evaluation above!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Species Detection Statistics -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dove me-2"></i>Species Detection Stats</h5>
                </div>
                <div class="card-body">
                    <div class="species-chart-container">
                        <canvas id="speciesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Usage Statistics -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Model Usage Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Model</th>
                                    <th>Images Processed</th>
                                    <th>Avg. Confidence</th>
                                    <th>Avg. Inference Time</th>
                                    <th>Usage %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usage in model_usage %}
                                <tr>
                                    <td><strong>{{ usage.ai_model }}</strong></td>
                                    <td>{{ usage.count }}</td>
                                    <td>
                                        {% if usage.avg_confidence %}
                                            {{ usage.avg_confidence|floatformat:3 }}
                                            <small class="text-muted">({{ usage.avg_confidence|floatformat:1 }})</small>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if usage.avg_inference_time %}
                                            {{ usage.avg_inference_time|floatformat:3 }}s
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            {% widthratio usage.count total_processed_images 100 as percentage %}
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ percentage }}%">
                                                {{ percentage }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Running Model Evaluation</h5>
                <p class="text-muted">This may take a few minutes depending on your dataset size...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Species Chart
    const speciesData = {{ species_stats|safe }};
    const speciesCtx = document.getElementById('speciesChart').getContext('2d');

    new Chart(speciesCtx, {
        type: 'doughnut',
        data: {
            labels: speciesData.map(s => s.name),
            datasets: [{
                data: speciesData.map(s => s.count),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            }
        }
    });

    // Evaluation Form Submission
    document.getElementById('evaluationForm').addEventListener('submit', function(e) {
        e.preventDefault();

        console.log('Form submitted!'); // Debug log

        // Prevent double submissions
        const submitBtn = document.getElementById('startEvaluationBtn');
        const submitStatus = document.getElementById('submitStatus');

        if (submitBtn.disabled) {
            console.log('Form already being submitted, ignoring duplicate request');
            return;
        }

        // Disable button and show status
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
        submitStatus.style.display = 'block';

        // Collect form data
        const formData = {
            name: document.getElementById('runName').value || `Evaluation Run ${new Date().toLocaleDateString()}`,
            description: document.getElementById('runDescription').value,
            iou_threshold: parseFloat(document.getElementById('ioUThreshold').value),
            confidence_threshold: parseFloat(document.getElementById('confidenceThreshold').value),
            models: Array.from(document.querySelectorAll('input[type="checkbox"][id^="model_"]:checked')).map(cb => cb.value),
            species: Array.from(document.querySelectorAll('input[type="checkbox"][id^="species_"]:checked')).map(cb => cb.value),
            date_start: document.getElementById('dateStart').value || null,
            date_end: document.getElementById('dateEnd').value || null
        };

        console.log('Form data:', formData); // Debug log

        // Validation
        if (formData.models.length === 0) {
            alert('Please select at least one model to evaluate.');
            console.log('Validation failed: No models selected');
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Start Evaluation Run';
            submitStatus.style.display = 'none';
            return;
        }

        if (formData.species.length === 0) {
            alert('Please select at least one species to include.');
            console.log('Validation failed: No species selected');
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Start Evaluation Run';
            submitStatus.style.display = 'none';
            return;
        }

        console.log('Validation passed, proceeding with submission');

        // Show loading modal
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();

        // Submit evaluation
        console.log('Submitting to:', '{% url "image_processing:create_evaluation_run" %}'); // Debug log
        console.log('CSRF Token:', document.querySelector('[name=csrfmiddlewaretoken]').value); // Debug log

        fetch('{% url "image_processing:create_evaluation_run" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            return response.json();
        })
                .then(data => {
            console.log('Response data:', data); // Debug log

            // Properly hide the loading modal with a small delay to ensure smooth transition
            setTimeout(() => {
                loadingModal.hide();

                if (data.success) {
                    // Show progress modal instead of redirecting immediately
                    showEvaluationProgressModal(data.evaluation_run_id, data.redirect_url);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                }
            }, 500);
        })
        .catch(error => {
            console.error('Fetch error:', error); // Debug log
            loadingModal.hide();
            console.error('Error:', error);
            alert('An error occurred while starting the evaluation.');

            // Re-enable button on error
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Start Evaluation Run';
            submitStatus.style.display = 'none';
        });
    });
});

// Progress Modal Functions
function showEvaluationProgressModal(evaluationRunId, redirectUrl) {
    // Remove any existing progress modals first
    const existingModals = document.querySelectorAll('#evaluationProgressModal');
    existingModals.forEach(modal => modal.remove());

    // Clear any existing intervals
    if (window.progressMonitoringInterval) {
        clearInterval(window.progressMonitoringInterval);
        window.progressMonitoringInterval = null;
    }

    // Create the modal
    const modalHtml = `
        <div class="modal fade" id="evaluationProgressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="progressModalLabel">
                            <i class="fas fa-chart-line me-2"></i>Evaluation Progress
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <h4 id="evaluation-name">Evaluation Run</h4>
                            <div id="evaluation-status" class="mt-3">
                                <span class="badge bg-warning fs-6">‚è≥ Initializing...</span>
                            </div>
                        </div>

                        <div class="progress mb-3" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar bg-info progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>

                        <div id="progress-details" class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Preparing evaluation...</strong><br>
                                <small>Setting up models and gathering data</small>
                            </div>
                        </div>

                        <div id="helpful-tips" class="mt-3" style="display: none;">
                            <div class="alert alert-light border">
                                <h6><i class="fas fa-lightbulb me-2"></i>Status Information</h6>
                                <div id="tips-content"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-success" id="viewResultsBtn" style="display: none;" onclick="redirectToResults()">
                            <i class="fas fa-eye me-2"></i>View Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const progressModal = document.getElementById('evaluationProgressModal');

    // Store the redirect URL for later use
    progressModal.dataset.redirectUrl = redirectUrl;
    progressModal.dataset.evaluationRunId = evaluationRunId;

    // Show the modal
    const modal = new bootstrap.Modal(progressModal);
    modal.show();

    // Start monitoring progress
    startProgressMonitoring(evaluationRunId);
}

function startProgressMonitoring(evaluationRunId) {
    const statusUrl = `/image-processing/api/evaluation/status/${evaluationRunId}/`;

    function checkProgress() {
        fetch(statusUrl, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            updateProgressModal(data);

            // Stop monitoring if evaluation is complete
            if (data.status === 'COMPLETED' || data.status === 'FAILED') {
                if (window.progressMonitoringInterval) {
                    clearInterval(window.progressMonitoringInterval);
                    window.progressMonitoringInterval = null;
                }
                handleEvaluationComplete(data);
            }
        })
        .catch(error => {
            console.error('Error checking progress:', error);
            showProgressError('Failed to check evaluation progress');
        });
    }

    // Check immediately, then every 3 seconds
    checkProgress();
    window.progressMonitoringInterval = setInterval(checkProgress, 3000);
}

function updateProgressModal(data) {
    const progressBar = document.getElementById('progress-bar');
    const progressDetails = document.getElementById('progress-details');
    const evaluationStatus = document.getElementById('evaluation-status');
    const evaluationName = document.getElementById('evaluation-name');
    const helpfulTips = document.getElementById('helpful-tips');
    const tipsContent = document.getElementById('tips-content');

    if (!progressBar || !progressDetails) return;

    // Update progress bar
    const percentage = data.progress_percentage || 0;
    progressBar.style.width = `${percentage}%`;
    progressBar.setAttribute('aria-valuenow', percentage);
    progressBar.textContent = `${percentage}%`;

    // Update status badge
    let statusClass = 'bg-warning';
    let statusIcon = '‚è≥';
    let statusText = 'Pending';

    switch (data.status) {
        case 'COMPLETED':
            statusClass = 'bg-success';
            statusIcon = '‚úÖ';
            statusText = 'Completed';
            break;
        case 'FAILED':
            statusClass = 'bg-danger';
            statusIcon = '‚ùå';
            statusText = 'Failed';
            break;
        case 'PROCESSING':
            statusClass = 'bg-info';
            statusIcon = 'üîÑ';
            statusText = 'Processing';
            break;
    }

    evaluationStatus.innerHTML = `<span class="badge ${statusClass} fs-6">${statusIcon} ${statusText}</span>`;
    evaluationName.textContent = data.name || 'Evaluation Run';

    // Update progress details
    let detailsHtml = '';

    if (data.status === 'PROCESSING') {
        detailsHtml = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                <strong>${data.current_step || 'Processing...'}</strong><br>
                <small>Progress: ${percentage}% complete</small>
            </div>
        `;
    } else if (data.status === 'PENDING') {
        detailsHtml = `
            <div class="alert alert-warning">
                <i class="fas fa-clock me-2"></i>
                <strong>Evaluation is queued</strong><br>
                <small>Waiting to start processing...</small>
            </div>
        `;
    } else if (data.status === 'COMPLETED') {
        detailsHtml = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Evaluation completed successfully!</strong><br>
                <small>All metrics have been calculated and are ready to view.</small>
            </div>
        `;
    } else if (data.status === 'FAILED') {
        detailsHtml = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Evaluation failed</strong><br>
                <small>${data.error_message || 'An error occurred during processing.'}</small>
            </div>
        `;
    }

    progressDetails.innerHTML = detailsHtml;

    // Show helpful tips if available
    if (data.helpful_tips && data.helpful_tips.length > 0) {
        const tipsHtml = data.helpful_tips.map(tip => `<div class="mb-1">‚Ä¢ ${tip}</div>`).join('');
        tipsContent.innerHTML = tipsHtml;
        helpfulTips.style.display = 'block';
    } else {
        helpfulTips.style.display = 'none';
    }
}

function handleEvaluationComplete(data) {
    const viewResultsBtn = document.getElementById('viewResultsBtn');
    const progressModal = document.getElementById('evaluationProgressModal');

    if (data.status === 'COMPLETED') {
        // Show success message
        showProgressMessage('‚úÖ Evaluation completed successfully! You can now view the results.', 'success');

        // Show the "View Results" button
        if (viewResultsBtn) {
            viewResultsBtn.style.display = 'inline-block';
            viewResultsBtn.onclick = () => redirectToResults();
        }

        // Auto-redirect after 3 seconds
        setTimeout(() => {
            if (progressModal && progressModal.classList.contains('show')) {
                redirectToResults();
            }
        }, 3000);

    } else if (data.status === 'FAILED') {
        // Show error message
        showProgressMessage(`‚ùå Evaluation failed: ${data.error_message || 'Unknown error'}`, 'danger');
    }
}

function redirectToResults() {
    const progressModal = document.getElementById('evaluationProgressModal');
    const redirectUrl = progressModal?.dataset.redirectUrl;

    if (redirectUrl) {
        // Hide modal first
        const modal = bootstrap.Modal.getInstance(progressModal);
        if (modal) {
            modal.hide();
        }

        // Redirect to results page
        window.location.href = redirectUrl;
    }
}

function showProgressMessage(message, type = 'info') {
    // Remove existing messages
    const existingAlerts = document.querySelectorAll('.progress-message');
    existingAlerts.forEach(alert => alert.remove());

    // Create new message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show progress-message mt-2`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const modalBody = document.querySelector('#evaluationProgressModal .modal-body');
    if (modalBody) {
        modalBody.appendChild(alertDiv);
    }
}

function showProgressError(message) {
    showProgressMessage(message, 'danger');
}
</script>
{% endblock %}
