{% extends 'base.html' %}
{% load static %}

{% block title %}Image Detail - {{ image_upload.title }} - AVICAST{% endblock %}

{% block extra_css %}
<style>
    .detection-info {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .detection-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .confidence-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.25rem;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
        transition: width 0.3s ease;
    }

    .species-badge {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
    }

    .detection-number {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #007bff;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
        z-index: 10;
    }

    .image-container {
        position: relative;
        display: inline-block;
        max-width: 100%;
    }

    .detection-highlight {
        position: absolute;
        border: 3px solid #ff4444;
        background: rgba(255, 68, 68, 0.1);
        pointer-events: none;
        transition: opacity 0.2s ease;
    }

    .detection-highlight:hover {
        opacity: 0.8;
    }

    .storage-info {
        background: #e7f3ff;
        border: 1px solid #b8daff;
        border-radius: 8px;
        padding: 1rem;
    }

    .processing-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1rem;
        padding-left: 1rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -2rem;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #007bff;
    }

    .timeline-item.completed::before {
        background: #28a745;
    }

    .timeline-item.failed::before {
        background: #dc3545;
    }

    .timeline-line {
        position: absolute;
        left: -1.5rem;
        top: 1rem;
        width: 2px;
        height: calc(100% - 1rem);
        background: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'image_processing:list' %}">Image Library</a></li>
                    <li class="breadcrumb-item active">{{ image_upload.title }}</li>
                </ol>
            </nav>
            <h2>ðŸ“¸ {{ image_upload.title }}</h2>
            <p class="text-muted">{{ image_upload.description|default:"No description" }}</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'image_processing:list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Library
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Image Display -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        {% if processed_image_url %}
                            <i class="fas fa-search me-2"></i>Detection Results with Bounding Boxes
                        {% elif processing_result %}
                            <i class="fas fa-search me-2"></i>Detection Results (Original Image)
                        {% else %}
                            <i class="fas fa-image me-2"></i>Original Image
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body text-center">
                    {% if processed_image_url %}
                        <!-- Show processed image with bounding boxes drawn -->
                        <div class="image-container">
                            <img src="{{ processed_image_url }}"
                                 class="img-fluid rounded shadow"
                                 alt="{{ image_upload.title }} - Detection Results"
                                 id="main-image">
                        </div>
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Detection Results Overlay:</strong> Bounding boxes are drawn directly on the image above.
                        </div>
                    {% elif image_upload.image_file %}
                        <!-- Show original image without bounding boxes -->
                        <div class="image-container">
                            <img src="{{ image_upload.image_file.url }}"
                                 class="img-fluid rounded shadow"
                                 alt="{{ image_upload.title }}"
                                 id="main-image">

                            {% if processing_result and processing_result.bounding_box %}
                                {% for detection in processing_result.bounding_box.all_detections %}
                                    {% if detection.bounding_box %}
                                        <div class="detection-highlight"
                                             data-detection-id="{{ forloop.counter }}"
                                             style="
                                                 left: {{ detection.bounding_box.x|default:0 }}px;
                                                 top: {{ detection.bounding_box.y|default:0 }}px;
                                                 width: {{ detection.bounding_box.width|default:0 }}px;
                                                 height: {{ detection.bounding_box.height|default:0 }}px;
                                             "
                                             title="{{ detection.species }} ({{ detection.confidence|floatformat:1 }}%)">
                                            <div class="detection-number">{{ forloop.counter }}</div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% if processing_result %}
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Note:</strong> Bounding boxes shown as overlays. The processed image with drawn boxes will be available shortly.
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 400px;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                    {% endif %}

                    <!-- Image Info -->
                    <div class="mt-3 text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Dimensions:</strong> {{ image_upload.image_width|default:"?" }} Ã— {{ image_upload.image_height|default:"?" }} px
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>File Size:</strong> {{ image_upload.file_size|filesizeformat }}
                                    {% if image_upload.is_compressed %}
                                        (compressed from {{ image_upload.original_size|default:image_upload.file_size|filesizeformat }})
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detection Results & Info -->
        <div class="col-lg-4">
            {% if processing_result %}
                <!-- Detection Results -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bird me-2"></i>Detection Results
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if processing_result.detected_species %}
                            <div class="detection-info">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-star me-2"></i>Best Detection
                                </h6>
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="badge bg-primary species-badge">
                                        {{ processing_result.detected_species }}
                                    </span>
                                    <span class="text-muted small">
                                        {{ processing_result.confidence_score|floatformat:1 }}%
                                    </span>
                                </div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: {{ processing_result.confidence_score|floatformat:0 }}%"></div>
                                </div>
                            </div>
                        {% endif %}

                        {% if processing_result.bounding_box.all_detections %}
                            <h6 class="mb-3">
                                <i class="fas fa-list me-2"></i>All Detections ({{ processing_result.total_detections }})
                            </h6>

                            {% for detection in processing_result.bounding_box.all_detections %}
                                <div class="detection-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <strong>{{ detection.species }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                Confidence: {{ detection.confidence|floatformat:1 }}%
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-secondary">#{{ forloop.counter }}</span>
                                        </div>
                                    </div>
                                    {% if detection.bounding_box %}
                                        <div class="mt-2 small text-muted">
                                            Box: {{ detection.bounding_box.x|default:0 }}, {{ detection.bounding_box.y|default:0 }}
                                            ({{ detection.bounding_box.width|default:0 }}Ã—{{ detection.bounding_box.height|default:0 }})
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}

                        {% if processing_result.review_status %}
                            <div class="mt-3">
                                <span class="badge
                                    {% if processing_result.review_status == 'APPROVED' %}bg-success
                                    {% elif processing_result.review_status == 'REJECTED' %}bg-danger
                                    {% elif processing_result.review_status == 'OVERRIDDEN' %}bg-warning text-dark
                                    {% else %}bg-info{% endif %}">
                                    Review Status: {{ processing_result.get_review_status_display }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <!-- Processing Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>Processing Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This image hasn't been processed yet. Click the "Start Processing" button to begin AI analysis.
                        </div>
                        <button type="button" class="btn btn-success w-100" onclick="processSingleImage('{{ image_upload.pk }}')">
                            <i class="fas fa-play me-2"></i>Start Processing
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- Processing Timeline -->
            {% if image_upload.processing_started_at %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock me-2"></i>Processing Timeline
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="processing-timeline">
                            <div class="timeline-line"></div>

                            <div class="timeline-item {% if image_upload.processing_started_at %}completed{% endif %}">
                                <strong>Started Processing</strong><br>
                                <small class="text-muted">{{ image_upload.processing_started_at|date:"M d, Y g:i A" }}</small>
                            </div>

                            {% if image_upload.processing_completed_at %}
                                <div class="timeline-item completed">
                                    <strong>Completed Processing</strong><br>
                                    <small class="text-muted">{{ image_upload.processing_completed_at|date:"M d, Y g:i A" }}</small>
                                    {% if image_upload.processing_duration %}
                                        <br><small class="text-success">Duration: {{ image_upload.processing_duration }}</small>
                                    {% endif %}
                                </div>
                            {% elif image_upload.upload_status == 'FAILED' %}
                                <div class="timeline-item failed">
                                    <strong>Processing Failed</strong><br>
                                    <small class="text-muted">Error occurred during analysis</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Storage Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-server me-2"></i>Storage Info
                    </h5>
                </div>
                <div class="card-body">
                    <div class="storage-info">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h4 text-primary">{{ image_upload.file_size|filesizeformat }}</div>
                                <small class="text-muted">File Size</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 text-info">{{ image_upload.storage_tier }}</div>
                                <small class="text-muted">Storage Tier</small>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-12">
                                <small class="text-muted">
                                    <strong>Uploaded:</strong> {{ image_upload.uploaded_at|date:"M d, Y g:i A" }}<br>
                                    <strong>By:</strong> {{ image_upload.uploaded_by.get_full_name|default:image_upload.uploaded_by.username }}<br>
                                    {% if image_upload.is_compressed %}
                                        <span class="badge bg-success">Compressed</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cogs me-2"></i>Processing Image...
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div id="processingStatus">Initializing...</div>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         id="processingProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Highlight detection on hover
    const highlights = document.querySelectorAll('.detection-highlight');
    highlights.forEach(highlight => {
        highlight.addEventListener('mouseenter', function() {
            const detectionId = this.getAttribute('data-detection-id');
            // You could add highlighting logic here
        });

        highlight.addEventListener('mouseleave', function() {
            // Remove highlighting
        });
    });
});

function processSingleImage(imageId) {
    // Show processing modal
    const modal = new bootstrap.Modal(document.getElementById('processingModal'));
    modal.show();

    // This would need to be implemented similar to the batch processing
    // For now, redirect to the list page to process
    setTimeout(() => {
        window.location.href = '{% url "image_processing:list" %}';
    }, 1000);
}
</script>
{% endblock %}
