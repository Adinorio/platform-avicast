{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Image - AVICAST{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">ðŸ“¸ Upload New Image</h3>
                    <p class="text-muted mb-0">Upload bird survey images for processing and storage</p>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}

                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <h6>Please correct the following errors:</h6>
                            {{ form.errors }}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.image_file.id_for_label }}" class="form-label">
                                {{ form.image_file.label }}
                            </label>
                            {{ form.image_file }}
                            {% if form.image_file.help_text %}
                            <div class="form-text">{{ form.image_file.help_text }}</div>
                            {% endif %}
                            {% if form.image_file.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.image_file.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                {{ form.title.label }}
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.title.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                {{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                <i class="fas fa-upload me-2"></i>Upload Image
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Upload Progress -->
            <div class="card mt-3 d-none" id="progressCard">
                <div class="card-body">
                    <h6>Upload Progress</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                    <small class="text-muted" id="progressText">Preparing upload...</small>
                </div>
            </div>

            <!-- Storage Information -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">ðŸ’¾ Storage Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">Supported Formats:</small>
                            <p class="mb-1">JPG, JPEG, PNG, GIF</p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Maximum Size:</small>
                            <p class="mb-1">50 MB per image</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">Automatic Optimization:</small>
                            <p class="mb-1">âœ… Enabled (60-80% space savings)</p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Duplicate Detection:</small>
                            <p class="mb-1">âœ… SHA256 hash checking</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" class="img-fluid" alt="Preview">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ form.image_file.id_for_label }}');
    const uploadForm = document.getElementById('uploadForm');
    const progressCard = document.getElementById('progressCard');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const uploadBtn = document.getElementById('uploadBtn');

    // File preview
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;

                // Show preview modal
                const modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            };
            reader.readAsDataURL(file);

            // Update button text
            uploadBtn.innerHTML = `<i class="fas fa-upload me-2"></i>Upload ${file.name}`;
        }
    });

    // Form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        // Show progress
        progressCard.classList.remove('d-none');
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';

        // Simulate progress (in real app, this would be AJAX with progress tracking)
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 90) progress = 90;

            progressBar.style.width = progress + '%';
            progressText.textContent = `Uploading... ${Math.round(progress)}%`;
        }, 200);

        // Form will submit normally
    });
});
</script>
{% endblock %}
