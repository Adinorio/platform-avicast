{% extends 'base.html' %}
{% load static %}

{% block title %}Select Images for Evaluation{% endblock %}

{% block extra_css %}
<style>
    .image-card {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    
    .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .image-card.selected {
        border: 3px solid #007bff;
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(0,123,255,0.3);
    }
    
    .image-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        color: white;
        padding: 1rem;
        font-size: 0.85rem;
    }
    
    .selection-checkbox {
        position: absolute;
        top: 10px;
        right: 10px;
        transform: scale(1.5);
        z-index: 10;
    }
    
    .filter-panel {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .stats-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .review-status-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
    }
    
    .confidence-bar {
        height: 4px;
        background: rgba(255,255,255,0.3);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        transition: width 0.3s ease;
    }
    
    .evaluation-preview {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border-radius: 50px;
        padding: 1rem 1.5rem;
        box-shadow: 0 8px 25px rgba(0,123,255,0.3);
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .evaluation-preview:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(0,123,255,0.4);
    }
    
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .image-placeholder {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px 8px 0 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">üéØ Select Images for Evaluation</h1>
            <p class="text-muted mb-0">Choose specific images to include in your model evaluation run</p>
        </div>
        <div>
            <a href="{% url 'image_processing:analytics_dashboard' %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-arrow-left me-2"></i>Back to Analytics
            </a>
            <button id="selectAllBtn" class="btn btn-outline-success me-2">
                <i class="fas fa-check-double me-2"></i>Select All Visible
            </button>
            <button id="clearSelectionBtn" class="btn btn-outline-warning">
                <i class="fas fa-times me-2"></i>Clear Selection
            </button>
        </div>
    </div>

    <!-- Stats Panel -->
    <div class="stats-panel">
        <div class="row text-center">
            <div class="col-md-3">
                <h3 class="mb-1">{{ total_images }}</h3>
                <small>Total Images</small>
            </div>
            <div class="col-md-3">
                <h3 class="mb-1" id="selectedCount">0</h3>
                <small>Selected</small>
            </div>
            <div class="col-md-3">
                <h3 class="mb-1">{{ page_obj.paginator.num_pages }}</h3>
                <small>Pages</small>
            </div>
            <div class="col-md-3">
                <h3 class="mb-1">{{ page_obj.object_list|length }}</h3>
                <small>On This Page</small>
            </div>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel">
        <form method="GET" id="filterForm">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Models</label>
                    <select name="model" class="form-select" multiple>
                        {% for model in available_models %}
                        <option value="{{ model }}" {% if model in current_filters.model %}selected{% endif %}>
                            {{ model }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Species</label>
                    <select name="species" class="form-select" multiple>
                        {% for species in available_species %}
                        <option value="{{ species }}" {% if species in current_filters.species %}selected{% endif %}>
                            {{ species }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Review Status</label>
                    <select name="review_status" class="form-select" multiple>
                        {% for status_value, status_label in available_review_statuses %}
                        <option value="{{ status_value }}" {% if status_value in current_filters.review_status %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="date" name="date_start" class="form-control" value="{{ current_filters.date_start }}">
                        </div>
                        <div class="col-6">
                            <input type="date" name="date_end" class="form-control" value="{{ current_filters.date_end }}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>Apply Filters
                    </button>
                    <a href="{% url 'image_processing:image_selection' %}" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Image Grid -->
    <div class="image-grid">
        {% for result in page_obj %}
        <div class="image-card" data-image-id="{{ result.id }}" data-image-path="{{ result.image_upload.image_file.url }}">
            <input type="checkbox" class="form-check-input selection-checkbox" data-image-id="{{ result.id }}">
            
            {% if result.image_upload.image_file %}
            <img src="{{ result.image_upload.image_file.url }}" 
                 alt="{{ result.image_upload.title }}" 
                 class="image-placeholder"
                 loading="lazy">
            {% else %}
            <div class="image-placeholder bg-light d-flex align-items-center justify-content-center">
                <i class="fas fa-image fa-3x text-muted"></i>
            </div>
            {% endif %}
            
            <div class="image-overlay">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong>{{ result.image_upload.title|truncatechars:25 }}</strong>
                        <br>
                        <small>{{ result.ai_model }}</small>
                    </div>
                    <div class="text-end">
                        {% if result.review_status == 'APPROVED' %}
                            <span class="badge bg-success review-status-badge">‚úì Approved</span>
                        {% elif result.review_status == 'REJECTED' %}
                            <span class="badge bg-danger review-status-badge">‚úó Rejected</span>
                        {% elif result.review_status == 'OVERRIDDEN' %}
                            <span class="badge bg-warning review-status-badge">‚ö† Overridden</span>
                        {% else %}
                            <span class="badge bg-secondary review-status-badge">‚è≥ Pending</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row g-2">
                    <div class="col-6">
                        <small>Species:</small>
                        <br>
                        <small><strong>{{ result.detected_species|default:"Unknown" }}</strong></small>
                    </div>
                    <div class="col-6">
                        <small>Detections:</small>
                        <br>
                        <small><strong>{{ result.total_detections|default:0 }}</strong></small>
                    </div>
                </div>
                
                <div class="mt-2">
                    <small>Confidence: {{ result.confidence_score|floatformat:1 }}%</small>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: {{ result.confidence_score|default:0 }}%"></div>
                    </div>
                </div>
                
                <div class="mt-2">
                    <small class="text-muted">
                        Processed: {{ result.created_at|date:"M d, Y H:i" }}
                        {% if result.inference_time %}
                        | {{ result.inference_time|floatformat:2 }}s
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-images fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Images Found</h4>
                <p class="text-muted">Try adjusting your filters or upload more images.</p>
                <a href="{% url 'image_processing:upload' %}" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload Images
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Image pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% for v in value %}&{{ key }}={{ v }}{% endfor %}{% endfor %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for page_num in page_obj.paginator.page_range %}
                {% if page_num == page_obj.number %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% elif page_num > page_obj.number|add:-3 and page_num < page_obj.number|add:3 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_num }}{% for key, value in current_filters.items %}{% for v in value %}&{{ key }}={{ v }}{% endfor %}{% endfor %}">
                        {{ page_num }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% for v in value %}&{{ key }}={{ v }}{% endfor %}{% endfor %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    <!-- Floating Evaluation Preview -->
    <div class="evaluation-preview" id="evaluationPreview" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="me-3">
                <strong id="previewCount">0</strong> images selected
                <br>
                <small>Ready for evaluation</small>
            </div>
            <button class="btn btn-light btn-sm" id="startEvaluationBtn">
                <i class="fas fa-play me-2"></i>Start Evaluation
            </button>
        </div>
    </div>
</div>

<!-- Evaluation Configuration Modal -->
<div class="modal fade" id="evaluationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Evaluation Run</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="evaluationForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Evaluation Name</label>
                                <input type="text" class="form-control" id="evaluationName" 
                                       value="Custom Selection - {{ 'now'|date:'M d, Y H:i' }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control" id="evaluationDescription" 
                                       placeholder="Describe this evaluation run...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Models to Evaluate</label>
                                <select class="form-select" id="evaluationModels" multiple required>
                                    {% for model in available_models %}
                                    <option value="{{ model }}">{{ model }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Select models to compare</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">IoU Threshold</label>
                                <input type="number" class="form-control" id="iouThreshold" 
                                       value="0.50" step="0.05" min="0.1" max="0.95">
                                <small class="text-muted">For detection matching</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Confidence Threshold</label>
                                <input type="number" class="form-control" id="confidenceThreshold" 
                                       value="0.25" step="0.05" min="0.05" max="0.95">
                                <small class="text-muted">Minimum detection confidence</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Selected Images Summary</h6>
                        <div id="selectedImagesSummary">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEvaluationBtn">
                    <i class="fas fa-rocket me-2"></i>Start Evaluation Run
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedImages = new Set();
let evaluationModal;

document.addEventListener('DOMContentLoaded', function() {
    evaluationModal = new bootstrap.Modal(document.getElementById('evaluationModal'));
    
    // Initialize event listeners
    initializeImageSelection();
    initializeButtons();
    initializeEvaluationModal();
});

function initializeImageSelection() {
    // Handle image card clicks
    document.querySelectorAll('.image-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('.selection-checkbox');
                checkbox.checked = !checkbox.checked;
                toggleImageSelection(checkbox);
            }
        });
    });
    
    // Handle checkbox changes
    document.querySelectorAll('.selection-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleImageSelection(this);
        });
    });
}

function toggleImageSelection(checkbox) {
    const imageId = checkbox.dataset.imageId;
    const imageCard = checkbox.closest('.image-card');
    
    if (checkbox.checked) {
        selectedImages.add(imageId);
        imageCard.classList.add('selected');
    } else {
        selectedImages.delete(imageId);
        imageCard.classList.remove('selected');
    }
    
    updateSelectionDisplay();
}

function updateSelectionDisplay() {
    const count = selectedImages.size;
    
    // Update counter
    document.getElementById('selectedCount').textContent = count;
    
    // Show/hide floating preview
    const preview = document.getElementById('evaluationPreview');
    const previewCount = document.getElementById('previewCount');
    
    if (count > 0) {
        preview.style.display = 'block';
        previewCount.textContent = count;
    } else {
        preview.style.display = 'none';
    }
}

function initializeButtons() {
    // Select all visible images
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.selection-checkbox').forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                toggleImageSelection(checkbox);
            }
        });
    });
    
    // Clear selection
    document.getElementById('clearSelectionBtn').addEventListener('click', function() {
        document.querySelectorAll('.selection-checkbox').forEach(checkbox => {
            if (checkbox.checked) {
                checkbox.checked = false;
                toggleImageSelection(checkbox);
            }
        });
    });
    
    // Start evaluation
    document.getElementById('startEvaluationBtn').addEventListener('click', function() {
        if (selectedImages.size > 0) {
            showEvaluationModal();
        } else {
            alert('Please select at least one image for evaluation.');
        }
    });
}

function showEvaluationModal() {
    updateSelectedImagesSummary();
    evaluationModal.show();
}

function updateSelectedImagesSummary() {
    const summary = document.getElementById('selectedImagesSummary');
    const selectedCards = document.querySelectorAll('.image-card.selected');
    
    // Count by model and species
    const modelCounts = {};
    const speciesCounts = {};
    const reviewCounts = {};
    
    selectedCards.forEach(card => {
        const overlay = card.querySelector('.image-overlay');
        const model = overlay.querySelector('small').textContent.trim();
        const species = overlay.querySelector('strong').textContent.trim();
        const reviewBadge = overlay.querySelector('.review-status-badge').textContent.trim();
        
        modelCounts[model] = (modelCounts[model] || 0) + 1;
        speciesCounts[species] = (speciesCounts[species] || 0) + 1;
        reviewCounts[reviewBadge] = (reviewCounts[reviewBadge] || 0) + 1;
    });
    
    let summaryHtml = `
        <div class="row">
            <div class="col-md-4">
                <strong>By Model:</strong>
                <ul class="list-unstyled small">
    `;
    
    for (const [model, count] of Object.entries(modelCounts)) {
        summaryHtml += `<li>${model}: ${count} images</li>`;
    }
    
    summaryHtml += `
                </ul>
            </div>
            <div class="col-md-4">
                <strong>By Species:</strong>
                <ul class="list-unstyled small">
    `;
    
    for (const [species, count] of Object.entries(speciesCounts)) {
        summaryHtml += `<li>${species}: ${count} images</li>`;
    }
    
    summaryHtml += `
                </ul>
            </div>
            <div class="col-md-4">
                <strong>By Review Status:</strong>
                <ul class="list-unstyled small">
    `;
    
    for (const [status, count] of Object.entries(reviewCounts)) {
        summaryHtml += `<li>${status}: ${count} images</li>`;
    }
    
    summaryHtml += `
                </ul>
            </div>
        </div>
    `;
    
    summary.innerHTML = summaryHtml;
}

function initializeEvaluationModal() {
    document.getElementById('confirmEvaluationBtn').addEventListener('click', function() {
        createEvaluationRun();
    });
}

async function createEvaluationRun() {
    const button = document.getElementById('confirmEvaluationBtn');
    const originalText = button.innerHTML;
    
    try {
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
        button.disabled = true;
        
        // Get form data
        const data = {
            name: document.getElementById('evaluationName').value,
            description: document.getElementById('evaluationDescription').value,
            models: Array.from(document.getElementById('evaluationModels').selectedOptions).map(option => option.value),
            iou_threshold: parseFloat(document.getElementById('iouThreshold').value),
            confidence_threshold: parseFloat(document.getElementById('confidenceThreshold').value),
            selected_images: Array.from(selectedImages)
        };
        
        // Validate
        if (!data.models.length) {
            throw new Error('Please select at least one model to evaluate.');
        }
        
        if (selectedImages.size === 0) {
            throw new Error('No images selected for evaluation.');
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') || 
                         document.querySelector('meta[name=csrf-token]');
        const csrfValue = csrfToken ? (csrfToken.value || csrfToken.content) : '';
        
        // Create evaluation run
        const response = await fetch('/image-processing/analytics/create-evaluation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfValue
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            showMessage(`Evaluation run created successfully! Processing ${result.preview_image_count} images.`, 'success');
            
            // Close modal and redirect
            evaluationModal.hide();
            
            setTimeout(() => {
                window.location.href = result.redirect_url;
            }, 1500);
        } else {
            throw new Error(result.error || 'Failed to create evaluation run');
        }
        
    } catch (error) {
        console.error('Error creating evaluation run:', error);
        showMessage(error.message, 'danger');
    } finally {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function showMessage(message, type = 'info') {
    // Remove existing alerts
    document.querySelectorAll('.alert-dismissible').forEach(alert => alert.remove());
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Handle page navigation while preserving selection
window.addEventListener('beforeunload', function() {
    // Could save selection to localStorage for cross-page persistence
    localStorage.setItem('selectedImages', JSON.stringify(Array.from(selectedImages)));
});

// Restore selection on page load
window.addEventListener('load', function() {
    const saved = localStorage.getItem('selectedImages');
    if (saved) {
        const savedIds = JSON.parse(saved);
        savedIds.forEach(imageId => {
            const checkbox = document.querySelector(`[data-image-id="${imageId}"]`);
            if (checkbox && checkbox.type === 'checkbox') {
                checkbox.checked = true;
                toggleImageSelection(checkbox);
            }
        });
    }
});
</script>
{% endblock %}
